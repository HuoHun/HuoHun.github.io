<!doctype html>

<html lang="en">
<head>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="generator" content="PHPDoctor 2.0.5 (http://peej.github.com/phpdoctor/)">
<meta name="when" content="Sat, 02 Jul 2016 01:30:06 +0000">

<link rel="stylesheet" type="text/css" href="../stylesheet.css">
<link rel="start" href="../overview-summary.html">

<title>library\think\db\Query.php (ThinkPHP)</title>

</head>
<body id="file" onload="parent.document.title=document.title;">

<div class="header">
<h1>ThinkPHP</h1>
<ul>
<li><a href="../overview-summary.html">Overview</a></li>
<li>Package</li><li>Class</li><li>Tree</li><li><a href="../overview-files.html">Files</a></li>
<li><a href="../deprecated-list.html">Deprecated</a></li>
<li><a href="../todo-list.html">Todo</a></li>
<li><a href="../index-all.html">Index</a></li>
</ul>
</div>

<div class="small_links">
<a href="../index.html" target="_top">Frames</a>
<a href="../source\library\think\db\query.php.html" target="_top">No frames</a>
</div>
<hr>

<h1>library\think\db\Query.php</h1>
<hr>

<a name="line1"></a><pre><?php
<a name="line2"></a>// +----------------------------------------------------------------------
<a name="line3"></a>// | ThinkPHP [ WE CAN DO IT JUST THINK ]
<a name="line4"></a>// +----------------------------------------------------------------------
<a name="line5"></a>// | Copyright (c) 2006~2016 http://thinkphp.cn All rights reserved.
<a name="line6"></a>// +----------------------------------------------------------------------
<a name="line7"></a>// | Licensed ( http://www.apache.org/licenses/LICENSE-2.0 )
<a name="line8"></a>// +----------------------------------------------------------------------
<a name="line9"></a>// | Author: liu21st <liu21st@gmail.com>
<a name="line10"></a>// +----------------------------------------------------------------------
<a name="line11"></a>
<a name="line12"></a>namespace think\db;
<a name="line13"></a>
<a name="line14"></a>use PDO;
<a name="line15"></a>use think\Cache;
<a name="line16"></a>use think\Collection;
<a name="line17"></a>use think\Config;
<a name="line18"></a>use think\Db;
<a name="line19"></a>use think\db\Builder;
<a name="line20"></a>use think\db\Connection;
<a name="line21"></a>use think\db\exception\BindParamException;
<a name="line22"></a>use think\db\exception\DataNotFoundException;
<a name="line23"></a>use think\db\exception\ModelNotFoundException;
<a name="line24"></a>use think\Exception;
<a name="line25"></a>use think\exception\DbException;
<a name="line26"></a>use think\exception\PDOException;
<a name="line27"></a>use think\Loader;
<a name="line28"></a>use think\Model;
<a name="line29"></a>use think\model\Relation;
<a name="line30"></a>use think\Paginator;
<a name="line31"></a>
<a name="line32"></a>class Query
<a name="line33"></a>{
<a name="line34"></a>    // 数据库Connection对象实例
<a name="line35"></a>    protected $connection;
<a name="line36"></a>    // 数据库驱动类型
<a name="line37"></a>    protected $driver;
<a name="line38"></a>    // 当前模型类名称
<a name="line39"></a>    protected $model;
<a name="line40"></a>    // 当前数据表名称（含前缀）
<a name="line41"></a>    protected $table = '';
<a name="line42"></a>    // 当前数据表名称（不含前缀）
<a name="line43"></a>    protected $name = '';
<a name="line44"></a>    // 当前数据表前缀
<a name="line45"></a>    protected $prefix = '';
<a name="line46"></a>    // 查询参数
<a name="line47"></a>    protected $options = [];
<a name="line48"></a>    // 参数绑定
<a name="line49"></a>    protected $bind = [];
<a name="line50"></a>    // 数据表信息
<a name="line51"></a>    protected $info = [];
<a name="line52"></a>
<a name="line53"></a>    /**
<a name="line54"></a>     * 架构函数
<a name="line55"></a>     * @access public
<a name="line56"></a>     * @param Connection $connection 数据库对象实例
<a name="line57"></a>     * @param string $model 模型名
<a name="line58"></a>     */
<a name="line59"></a>    public function __construct(Connection $connection = null, $model = '')
<a name="line60"></a>    {
<a name="line61"></a>        $this->connection = $connection ?: Db::connect([], true);
<a name="line62"></a>        $this->driver     = $this->connection->getDriverName();
<a name="line63"></a>        $this->prefix     = $this->connection->getConfig('prefix');
<a name="line64"></a>        $this->model      = $model;
<a name="line65"></a>    }
<a name="line66"></a>
<a name="line67"></a>    /**
<a name="line68"></a>     * 利用__call方法实现一些特殊的Model方法
<a name="line69"></a>     * @access public
<a name="line70"></a>     * @param string    $method 方法名称
<a name="line71"></a>     * @param array     $args 调用参数
<a name="line72"></a>     * @return mixed
<a name="line73"></a>     * @throws DbException
<a name="line74"></a>     * @throws Exception
<a name="line75"></a>     */
<a name="line76"></a>    public function __call($method, $args)
<a name="line77"></a>    {
<a name="line78"></a>        if (strtolower(substr($method, 0, 5)) == 'getby') {
<a name="line79"></a>            // 根据某个字段获取记录
<a name="line80"></a>            $field         = Loader::parseName(substr($method, 5));
<a name="line81"></a>            $where[$field] = $args[0];
<a name="line82"></a>            return $this->where($where)->find();
<a name="line83"></a>        } elseif (strtolower(substr($method, 0, 10)) == 'getfieldby') {
<a name="line84"></a>            // 根据某个字段获取记录的某个值
<a name="line85"></a>            $name         = Loader::parseName(substr($method, 10));
<a name="line86"></a>            $where[$name] = $args[0];
<a name="line87"></a>            return $this->where($where)->value($args[1]);
<a name="line88"></a>        } else {
<a name="line89"></a>            throw new Exception('method not exist:' . __CLASS__ . '->' . $method);
<a name="line90"></a>        }
<a name="line91"></a>    }
<a name="line92"></a>
<a name="line93"></a>    /**
<a name="line94"></a>     * 获取当前的数据库Connection对象
<a name="line95"></a>     * @access public
<a name="line96"></a>     * @return Connection
<a name="line97"></a>     */
<a name="line98"></a>    public function getConnection()
<a name="line99"></a>    {
<a name="line100"></a>        return $this->connection;
<a name="line101"></a>    }
<a name="line102"></a>
<a name="line103"></a>    /**
<a name="line104"></a>     * 切换当前的数据库连接
<a name="line105"></a>     * @access public
<a name="line106"></a>     * @param mixed $config
<a name="line107"></a>     * @return $this
<a name="line108"></a>     */
<a name="line109"></a>    public function connect($config)
<a name="line110"></a>    {
<a name="line111"></a>        $this->connection = Db::connect($config);
<a name="line112"></a>        return $this;
<a name="line113"></a>    }
<a name="line114"></a>
<a name="line115"></a>    /**
<a name="line116"></a>     * 指定默认的数据表名（不含前缀）
<a name="line117"></a>     * @access public
<a name="line118"></a>     * @param string $name
<a name="line119"></a>     * @return $this
<a name="line120"></a>     */
<a name="line121"></a>    public function name($name)
<a name="line122"></a>    {
<a name="line123"></a>        $this->name = $name;
<a name="line124"></a>        return $this;
<a name="line125"></a>    }
<a name="line126"></a>
<a name="line127"></a>    /**
<a name="line128"></a>     * 指定默认数据表名（含前缀）
<a name="line129"></a>     * @access public
<a name="line130"></a>     * @param string $table 表名
<a name="line131"></a>     * @return $this
<a name="line132"></a>     */
<a name="line133"></a>    public function setTable($table)
<a name="line134"></a>    {
<a name="line135"></a>        $this->table = $table;
<a name="line136"></a>        return $this;
<a name="line137"></a>    }
<a name="line138"></a>
<a name="line139"></a>    /**
<a name="line140"></a>     * 得到当前或者指定名称的数据表
<a name="line141"></a>     * @access public
<a name="line142"></a>     * @param string $name
<a name="line143"></a>     * @return string
<a name="line144"></a>     */
<a name="line145"></a>    public function getTable($name = '')
<a name="line146"></a>    {
<a name="line147"></a>        if ($name || empty($this->table)) {
<a name="line148"></a>            $name      = $name ?: $this->name;
<a name="line149"></a>            $tableName = $this->prefix;
<a name="line150"></a>            if ($name) {
<a name="line151"></a>                $tableName .= Loader::parseName($name);
<a name="line152"></a>            }
<a name="line153"></a>        } else {
<a name="line154"></a>            $tableName = $this->table;
<a name="line155"></a>        }
<a name="line156"></a>        return $tableName;
<a name="line157"></a>    }
<a name="line158"></a>
<a name="line159"></a>    /**
<a name="line160"></a>     * 将SQL语句中的__TABLE_NAME__字符串替换成带前缀的表名（小写）
<a name="line161"></a>     * @access public
<a name="line162"></a>     * @param string $sql sql语句
<a name="line163"></a>     * @return string
<a name="line164"></a>     */
<a name="line165"></a>    public function parseSqlTable($sql)
<a name="line166"></a>    {
<a name="line167"></a>        if (false !== strpos($sql, '__')) {
<a name="line168"></a>            $prefix = $this->prefix;
<a name="line169"></a>            $sql    = preg_replace_callback("/__([A-Z0-9_-]+)__/sU", function ($match) use ($prefix) {
<a name="line170"></a>                return $prefix . strtolower($match[1]);
<a name="line171"></a>            }, $sql);
<a name="line172"></a>        }
<a name="line173"></a>        return $sql;
<a name="line174"></a>    }
<a name="line175"></a>
<a name="line176"></a>    /**
<a name="line177"></a>     * 执行查询 返回数据集
<a name="line178"></a>     * @access public
<a name="line179"></a>     * @param string        $sql sql指令
<a name="line180"></a>     * @param array         $bind 参数绑定
<a name="line181"></a>     * @param boolean       $master 是否在主服务器读操作
<a name="line182"></a>     * @param bool|string   $class 指定返回的数据集对象
<a name="line183"></a>     * @return mixed
<a name="line184"></a>     * @throws BindParamException
<a name="line185"></a>     * @throws PDOException
<a name="line186"></a>     */
<a name="line187"></a>    public function query($sql, $bind = [], $master = false, $class = false)
<a name="line188"></a>    {
<a name="line189"></a>        return $this->connection->query($sql, $bind, $master, $class);
<a name="line190"></a>    }
<a name="line191"></a>
<a name="line192"></a>    /**
<a name="line193"></a>     * 执行语句
<a name="line194"></a>     * @access public
<a name="line195"></a>     * @param string    $sql sql指令
<a name="line196"></a>     * @param array     $bind 参数绑定
<a name="line197"></a>     * @param boolean   $getLastInsID 是否获取自增ID
<a name="line198"></a>     * @param boolean   $sequence 自增序列名
<a name="line199"></a>     * @return int
<a name="line200"></a>     * @throws BindParamException
<a name="line201"></a>     * @throws PDOException
<a name="line202"></a>     */
<a name="line203"></a>    public function execute($sql, $bind = [], $getLastInsID = false, $sequence = null)
<a name="line204"></a>    {
<a name="line205"></a>        return $this->connection->execute($sql, $bind, $getLastInsID, $sequence);
<a name="line206"></a>    }
<a name="line207"></a>
<a name="line208"></a>    /**
<a name="line209"></a>     * 获取最近插入的ID
<a name="line210"></a>     * @access public
<a name="line211"></a>     * @return string
<a name="line212"></a>     */
<a name="line213"></a>    public function getLastInsID()
<a name="line214"></a>    {
<a name="line215"></a>        return $this->connection->getLastInsID();
<a name="line216"></a>    }
<a name="line217"></a>
<a name="line218"></a>    /**
<a name="line219"></a>     * 获取最近一次查询的sql语句
<a name="line220"></a>     * @access public
<a name="line221"></a>     * @return string
<a name="line222"></a>     */
<a name="line223"></a>    public function getLastSql()
<a name="line224"></a>    {
<a name="line225"></a>        return $this->connection->getLastSql();
<a name="line226"></a>    }
<a name="line227"></a>
<a name="line228"></a>    /**
<a name="line229"></a>     * 执行数据库事务
<a name="line230"></a>     * @access public
<a name="line231"></a>     * @param callable $callback 数据操作方法回调
<a name="line232"></a>     * @return mixed
<a name="line233"></a>     */
<a name="line234"></a>    public function transaction($callback)
<a name="line235"></a>    {
<a name="line236"></a>        return $this->connection->transaction($callback);
<a name="line237"></a>    }
<a name="line238"></a>
<a name="line239"></a>    /**
<a name="line240"></a>     * 启动事务
<a name="line241"></a>     * @access public
<a name="line242"></a>     * @return bool|null
<a name="line243"></a>     */
<a name="line244"></a>    public function startTrans()
<a name="line245"></a>    {
<a name="line246"></a>        return $this->connection->startTrans();
<a name="line247"></a>    }
<a name="line248"></a>
<a name="line249"></a>    /**
<a name="line250"></a>     * 用于非自动提交状态下面的查询提交
<a name="line251"></a>     * @access public
<a name="line252"></a>     * @return boolean
<a name="line253"></a>     * @throws PDOException
<a name="line254"></a>     */
<a name="line255"></a>    public function commit()
<a name="line256"></a>    {
<a name="line257"></a>        return $this->connection->commit();
<a name="line258"></a>    }
<a name="line259"></a>
<a name="line260"></a>    /**
<a name="line261"></a>     * 事务回滚
<a name="line262"></a>     * @access public
<a name="line263"></a>     * @return boolean
<a name="line264"></a>     * @throws PDOException
<a name="line265"></a>     */
<a name="line266"></a>    public function rollback()
<a name="line267"></a>    {
<a name="line268"></a>        return $this->connection->rollback();
<a name="line269"></a>    }
<a name="line270"></a>
<a name="line271"></a>    /**
<a name="line272"></a>     * 批处理执行SQL语句
<a name="line273"></a>     * 批处理的指令都认为是execute操作
<a name="line274"></a>     * @access public
<a name="line275"></a>     * @param array $sql SQL批处理指令
<a name="line276"></a>     * @return boolean
<a name="line277"></a>     */
<a name="line278"></a>    public function batchQuery($sql = [])
<a name="line279"></a>    {
<a name="line280"></a>        return $this->connection->batchQuery($sql);
<a name="line281"></a>    }
<a name="line282"></a>
<a name="line283"></a>    /**
<a name="line284"></a>     * 获取数据库的配置参数
<a name="line285"></a>     * @access public
<a name="line286"></a>     * @param string $name 参数名称
<a name="line287"></a>     * @return boolean
<a name="line288"></a>     */
<a name="line289"></a>    public function getConfig($name = '')
<a name="line290"></a>    {
<a name="line291"></a>        return $this->connection->getConfig($name);
<a name="line292"></a>    }
<a name="line293"></a>
<a name="line294"></a>    /**
<a name="line295"></a>     * 得到分表的的数据表名
<a name="line296"></a>     * @access public
<a name="line297"></a>     * @param array     $data 操作的数据
<a name="line298"></a>     * @param string    $field 分表依据的字段
<a name="line299"></a>     * @param array     $rule 分表规则
<a name="line300"></a>     * @return string
<a name="line301"></a>     */
<a name="line302"></a>    public function getPartitionTableName($data, $field, $rule = [])
<a name="line303"></a>    {
<a name="line304"></a>        // 对数据表进行分区
<a name="line305"></a>        if ($field && isset($data[$field])) {
<a name="line306"></a>            $value = $data[$field];
<a name="line307"></a>            $type  = $rule['type'];
<a name="line308"></a>            switch ($type) {
<a name="line309"></a>                case 'id':
<a name="line310"></a>                    // 按照id范围分表
<a name="line311"></a>                    $step = $rule['expr'];
<a name="line312"></a>                    $seq  = floor($value / $step) + 1;
<a name="line313"></a>                    break;
<a name="line314"></a>                case 'year':
<a name="line315"></a>                    // 按照年份分表
<a name="line316"></a>                    if (!is_numeric($value)) {
<a name="line317"></a>                        $value = strtotime($value);
<a name="line318"></a>                    }
<a name="line319"></a>                    $seq = date('Y', $value) - $rule['expr'] + 1;
<a name="line320"></a>                    break;
<a name="line321"></a>                case 'mod':
<a name="line322"></a>                    // 按照id的模数分表
<a name="line323"></a>                    $seq = ($value % $rule['num']) + 1;
<a name="line324"></a>                    break;
<a name="line325"></a>                case 'md5':
<a name="line326"></a>                    // 按照md5的序列分表
<a name="line327"></a>                    $seq = (ord(substr(md5($value), 0, 1)) % $rule['num']) + 1;
<a name="line328"></a>                    break;
<a name="line329"></a>                default:
<a name="line330"></a>                    if (function_exists($type)) {
<a name="line331"></a>                        // 支持指定函数哈希
<a name="line332"></a>                        $seq = (ord(substr($type($value), 0, 1)) % $rule['num']) + 1;
<a name="line333"></a>                    } else {
<a name="line334"></a>                        // 按照字段的首字母的值分表
<a name="line335"></a>                        $seq = (ord($value{0}) % $rule['num']) + 1;
<a name="line336"></a>                    }
<a name="line337"></a>            }
<a name="line338"></a>            return $this->getTable() . '_' . $seq;
<a name="line339"></a>        } else {
<a name="line340"></a>            // 当设置的分表字段不在查询条件或者数据中
<a name="line341"></a>            // 进行联合查询，必须设定 partition['num']
<a name="line342"></a>            $tableName = [];
<a name="line343"></a>            for ($i = 0; $i < $rule['num']; $i++) {
<a name="line344"></a>                $tableName[] = 'SELECT * FROM ' . $this->getTable() . '_' . ($i + 1);
<a name="line345"></a>            }
<a name="line346"></a>
<a name="line347"></a>            $tableName = '( ' . implode(" UNION ", $tableName) . ') AS ' . $this->name;
<a name="line348"></a>            return $tableName;
<a name="line349"></a>        }
<a name="line350"></a>    }
<a name="line351"></a>
<a name="line352"></a>    /**
<a name="line353"></a>     * 获取当前的builder实例对象
<a name="line354"></a>     * @access protected
<a name="line355"></a>     * @return Builder
<a name="line356"></a>     */
<a name="line357"></a>    protected function builder()
<a name="line358"></a>    {
<a name="line359"></a>        static $builder = [];
<a name="line360"></a>        $driver         = $this->driver;
<a name="line361"></a>        if (!isset($builder[$driver])) {
<a name="line362"></a>            $class            = '\\think\\db\\builder\\' . ucfirst($driver);
<a name="line363"></a>            $builder[$driver] = new $class($this->connection);
<a name="line364"></a>        }
<a name="line365"></a>        // 设置当前查询对象
<a name="line366"></a>        $builder[$driver]->setQuery($this);
<a name="line367"></a>        return $builder[$driver];
<a name="line368"></a>    }
<a name="line369"></a>
<a name="line370"></a>    /**
<a name="line371"></a>     * 得到某个字段的值
<a name="line372"></a>     * @access public
<a name="line373"></a>     * @param string    $field 字段名
<a name="line374"></a>     * @param mixed     $default 默认值
<a name="line375"></a>     * @return mixed
<a name="line376"></a>     */
<a name="line377"></a>    public function value($field, $default = null)
<a name="line378"></a>    {
<a name="line379"></a>        $result = null;
<a name="line380"></a>        if (!empty($this->options['cache'])) {
<a name="line381"></a>            // 判断查询缓存
<a name="line382"></a>            $cache = $this->options['cache'];
<a name="line383"></a>            if (empty($this->options['table'])) {
<a name="line384"></a>                $this->options['table'] = $this->getTable();
<a name="line385"></a>            }
<a name="line386"></a>            $key    = is_string($cache['key']) ? $cache['key'] : md5($field . serialize($this->options));
<a name="line387"></a>            $result = Cache::get($key);
<a name="line388"></a>        }
<a name="line389"></a>        if (!$result) {
<a name="line390"></a>            if (isset($this->options['field'])) {
<a name="line391"></a>                unset($this->options['field']);
<a name="line392"></a>            }
<a name="line393"></a>            $pdo    = $this->field($field)->fetchPdo(true)->find();
<a name="line394"></a>            $result = $pdo->fetchColumn();
<a name="line395"></a>            if (isset($cache)) {
<a name="line396"></a>                // 缓存数据
<a name="line397"></a>                Cache::set($key, $result, $cache['expire']);
<a name="line398"></a>            }
<a name="line399"></a>        } else {
<a name="line400"></a>            // 清空查询条件
<a name="line401"></a>            $this->options = [];
<a name="line402"></a>        }
<a name="line403"></a>        return !is_null($result) ? $result : $default;
<a name="line404"></a>    }
<a name="line405"></a>
<a name="line406"></a>    /**
<a name="line407"></a>     * 得到某个列的数组
<a name="line408"></a>     * @access public
<a name="line409"></a>     * @param string    $field 字段名 多个字段用逗号分隔
<a name="line410"></a>     * @param string    $key 索引
<a name="line411"></a>     * @return array
<a name="line412"></a>     */
<a name="line413"></a>    public function column($field, $key = '')
<a name="line414"></a>    {
<a name="line415"></a>        $result = false;
<a name="line416"></a>        if (!empty($this->options['cache'])) {
<a name="line417"></a>            // 判断查询缓存
<a name="line418"></a>            $cache = $this->options['cache'];
<a name="line419"></a>            if (empty($this->options['table'])) {
<a name="line420"></a>                $this->options['table'] = $this->getTable();
<a name="line421"></a>            }
<a name="line422"></a>            $guid   = is_string($cache['key']) ? $cache['key'] : md5($field . serialize($this->options));
<a name="line423"></a>            $result = Cache::get($guid);
<a name="line424"></a>        }
<a name="line425"></a>        if (!$result) {
<a name="line426"></a>            if (isset($this->options['field'])) {
<a name="line427"></a>                unset($this->options['field']);
<a name="line428"></a>            }
<a name="line429"></a>            if ($key && '*' != $field) {
<a name="line430"></a>                $field = $key . ',' . $field;
<a name="line431"></a>            }
<a name="line432"></a>            $pdo = $this->field($field)->fetchPdo(true)->select();
<a name="line433"></a>            if (1 == $pdo->columnCount()) {
<a name="line434"></a>                $result = $pdo->fetchAll(PDO::FETCH_COLUMN);
<a name="line435"></a>            } else {
<a name="line436"></a>                $resultSet = $pdo->fetchAll(PDO::FETCH_ASSOC);
<a name="line437"></a>                if ($resultSet) {
<a name="line438"></a>                    $fields = array_keys($resultSet[0]);
<a name="line439"></a>                    $count  = count($fields);
<a name="line440"></a>                    $key1   = array_shift($fields);
<a name="line441"></a>                    $key2   = $fields ? array_shift($fields) : '';
<a name="line442"></a>                    $key    = $key ?: $key1;
<a name="line443"></a>                    foreach ($resultSet as $val) {
<a name="line444"></a>                        if ($count > 2) {
<a name="line445"></a>                            $result[$val[$key]] = $val;
<a name="line446"></a>                        } elseif (2 == $count) {
<a name="line447"></a>                            $result[$val[$key]] = $val[$key2];
<a name="line448"></a>                        } elseif (1 == $count) {
<a name="line449"></a>                            $result[$val[$key]] = $val[$key1];
<a name="line450"></a>                        }
<a name="line451"></a>                    }
<a name="line452"></a>                } else {
<a name="line453"></a>                    $result = [];
<a name="line454"></a>                }
<a name="line455"></a>            }
<a name="line456"></a>            if (isset($cache) && isset($guid)) {
<a name="line457"></a>                // 缓存数据
<a name="line458"></a>                Cache::set($guid, $result, $cache['expire']);
<a name="line459"></a>            }
<a name="line460"></a>        } else {
<a name="line461"></a>            // 清空查询条件
<a name="line462"></a>            $this->options = [];
<a name="line463"></a>        }
<a name="line464"></a>        return $result;
<a name="line465"></a>    }
<a name="line466"></a>
<a name="line467"></a>    /**
<a name="line468"></a>     * COUNT查询
<a name="line469"></a>     * @access public
<a name="line470"></a>     * @param string $field 字段名
<a name="line471"></a>     * @return integer
<a name="line472"></a>     */
<a name="line473"></a>    public function count($field = '*')
<a name="line474"></a>    {
<a name="line475"></a>        return $this->value('COUNT(' . $field . ') AS tp_count', 0);
<a name="line476"></a>    }
<a name="line477"></a>
<a name="line478"></a>    /**
<a name="line479"></a>     * SUM查询
<a name="line480"></a>     * @access public
<a name="line481"></a>     * @param string $field 字段名
<a name="line482"></a>     * @return integer
<a name="line483"></a>     */
<a name="line484"></a>    public function sum($field = '*')
<a name="line485"></a>    {
<a name="line486"></a>        return $this->value('SUM(' . $field . ') AS tp_sum', 0);
<a name="line487"></a>    }
<a name="line488"></a>
<a name="line489"></a>    /**
<a name="line490"></a>     * MIN查询
<a name="line491"></a>     * @access public
<a name="line492"></a>     * @param string $field 字段名
<a name="line493"></a>     * @return integer
<a name="line494"></a>     */
<a name="line495"></a>    public function min($field = '*')
<a name="line496"></a>    {
<a name="line497"></a>        return $this->value('MIN(' . $field . ') AS tp_min', 0);
<a name="line498"></a>    }
<a name="line499"></a>
<a name="line500"></a>    /**
<a name="line501"></a>     * MAX查询
<a name="line502"></a>     * @access public
<a name="line503"></a>     * @param string $field 字段名
<a name="line504"></a>     * @return integer
<a name="line505"></a>     */
<a name="line506"></a>    public function max($field = '*')
<a name="line507"></a>    {
<a name="line508"></a>        return $this->value('MAX(' . $field . ') AS tp_max', 0);
<a name="line509"></a>    }
<a name="line510"></a>
<a name="line511"></a>    /**
<a name="line512"></a>     * AVG查询
<a name="line513"></a>     * @access public
<a name="line514"></a>     * @param string $field 字段名
<a name="line515"></a>     * @return integer
<a name="line516"></a>     */
<a name="line517"></a>    public function avg($field = '*')
<a name="line518"></a>    {
<a name="line519"></a>        return $this->value('AVG(' . $field . ') AS tp_avg', 0);
<a name="line520"></a>    }
<a name="line521"></a>
<a name="line522"></a>    /**
<a name="line523"></a>     * 设置记录的某个字段值
<a name="line524"></a>     * 支持使用数据库字段和方法
<a name="line525"></a>     * @access public
<a name="line526"></a>     * @param string|array  $field 字段名
<a name="line527"></a>     * @param mixed         $value 字段值
<a name="line528"></a>     * @return integer
<a name="line529"></a>     */
<a name="line530"></a>    public function setField($field, $value = '')
<a name="line531"></a>    {
<a name="line532"></a>        if (is_array($field)) {
<a name="line533"></a>            $data = $field;
<a name="line534"></a>        } else {
<a name="line535"></a>            $data[$field] = $value;
<a name="line536"></a>        }
<a name="line537"></a>        return $this->update($data);
<a name="line538"></a>    }
<a name="line539"></a>
<a name="line540"></a>    /**
<a name="line541"></a>     * 字段值(延迟)增长
<a name="line542"></a>     * @access public
<a name="line543"></a>     * @param string    $field 字段名
<a name="line544"></a>     * @param integer   $step 增长值
<a name="line545"></a>     * @param integer   $lazyTime 延时时间(s)
<a name="line546"></a>     * @return integer|true
<a name="line547"></a>     * @throws Exception
<a name="line548"></a>     */
<a name="line549"></a>    public function setInc($field, $step = 1, $lazyTime = 0)
<a name="line550"></a>    {
<a name="line551"></a>        $condition = !empty($this->options['where']) ? $this->options['where'] : [];
<a name="line552"></a>        if (empty($condition)) {
<a name="line553"></a>            // 没有条件不做任何更新
<a name="line554"></a>            throw new Exception('no data to update');
<a name="line555"></a>        }
<a name="line556"></a>        if ($lazyTime > 0) {
<a name="line557"></a>            // 延迟写入
<a name="line558"></a>            $guid = md5($this->getTable() . '_' . $field . '_' . serialize($condition));
<a name="line559"></a>            $step = $this->lazyWrite($guid, $step, $lazyTime);
<a name="line560"></a>            if (empty($step)) {
<a name="line561"></a>                return true; // 等待下次写入
<a name="line562"></a>            }
<a name="line563"></a>        }
<a name="line564"></a>        return $this->setField($field, ['exp', $field . '+' . $step]);
<a name="line565"></a>    }
<a name="line566"></a>
<a name="line567"></a>    /**
<a name="line568"></a>     * 字段值（延迟）减少
<a name="line569"></a>     * @access public
<a name="line570"></a>     * @param string    $field 字段名
<a name="line571"></a>     * @param integer   $step 减少值
<a name="line572"></a>     * @param integer   $lazyTime 延时时间(s)
<a name="line573"></a>     * @return integer|true
<a name="line574"></a>     * @throws Exception
<a name="line575"></a>     */
<a name="line576"></a>    public function setDec($field, $step = 1, $lazyTime = 0)
<a name="line577"></a>    {
<a name="line578"></a>        $condition = !empty($this->options['where']) ? $this->options['where'] : [];
<a name="line579"></a>        if (empty($condition)) {
<a name="line580"></a>            // 没有条件不做任何更新
<a name="line581"></a>            throw new Exception('no data to update');
<a name="line582"></a>        }
<a name="line583"></a>        if ($lazyTime > 0) {
<a name="line584"></a>            // 延迟写入
<a name="line585"></a>            $guid = md5($this->getTable() . '_' . $field . '_' . serialize($condition));
<a name="line586"></a>            $step = $this->lazyWrite($guid, -$step, $lazyTime);
<a name="line587"></a>            if (empty($step)) {
<a name="line588"></a>                return true; // 等待下次写入
<a name="line589"></a>            }
<a name="line590"></a>        }
<a name="line591"></a>        return $this->setField($field, ['exp', $field . '-' . $step]);
<a name="line592"></a>    }
<a name="line593"></a>
<a name="line594"></a>    /**
<a name="line595"></a>     * 延时更新检查 返回false表示需要延时
<a name="line596"></a>     * 否则返回实际写入的数值
<a name="line597"></a>     * @access public
<a name="line598"></a>     * @param string    $guid 写入标识
<a name="line599"></a>     * @param integer   $step 写入步进值
<a name="line600"></a>     * @param integer   $lazyTime 延时时间(s)
<a name="line601"></a>     * @return false|integer
<a name="line602"></a>     */
<a name="line603"></a>    protected function lazyWrite($guid, $step, $lazyTime)
<a name="line604"></a>    {
<a name="line605"></a>        if (false !== ($value = Cache::get($guid))) {
<a name="line606"></a>            // 存在缓存写入数据
<a name="line607"></a>            if ($_SERVER['REQUEST_TIME'] > Cache::get($guid . '_time') + $lazyTime) {
<a name="line608"></a>                // 延时更新时间到了，删除缓存数据 并实际写入数据库
<a name="line609"></a>                Cache::rm($guid);
<a name="line610"></a>                Cache::rm($guid . '_time');
<a name="line611"></a>                return $value + $step;
<a name="line612"></a>            } else {
<a name="line613"></a>                // 追加数据到缓存
<a name="line614"></a>                Cache::set($guid, $value + $step, 0);
<a name="line615"></a>                return false;
<a name="line616"></a>            }
<a name="line617"></a>        } else {
<a name="line618"></a>            // 没有缓存数据
<a name="line619"></a>            Cache::set($guid, $step, 0);
<a name="line620"></a>            // 计时开始
<a name="line621"></a>            Cache::set($guid . '_time', $_SERVER['REQUEST_TIME'], 0);
<a name="line622"></a>            return false;
<a name="line623"></a>        }
<a name="line624"></a>    }
<a name="line625"></a>
<a name="line626"></a>    /**
<a name="line627"></a>     * 查询SQL组装 join
<a name="line628"></a>     * @access public
<a name="line629"></a>     * @param mixed     $join 关联的表名
<a name="line630"></a>     * @param mixed     $condition 条件
<a name="line631"></a>     * @param string    $type JOIN类型
<a name="line632"></a>     * @return $this
<a name="line633"></a>     */
<a name="line634"></a>    public function join($join, $condition = null, $type = 'INNER')
<a name="line635"></a>    {
<a name="line636"></a>        if (empty($condition)) {
<a name="line637"></a>            // 如果为组数，则循环调用join
<a name="line638"></a>            foreach ($join as $key => $value) {
<a name="line639"></a>                if (is_array($value) && 2 <= count($value)) {
<a name="line640"></a>                    $this->join($value[0], $value[1], isset($value[2]) ? $value[2] : $type);
<a name="line641"></a>                }
<a name="line642"></a>            }
<a name="line643"></a>        } else {
<a name="line644"></a>            $prefix = $this->prefix;
<a name="line645"></a>            // 传入的表名为数组
<a name="line646"></a>            if (is_array($join)) {
<a name="line647"></a>                if (0 !== $key = key($join)) {
<a name="line648"></a>                    // 设置了键名则键名为表名，键值作为表的别名
<a name="line649"></a>                    $table = $key . ' ' . array_shift($join);
<a name="line650"></a>                } else {
<a name="line651"></a>                    $table = array_shift($join);
<a name="line652"></a>                }
<a name="line653"></a>                if (count($join)) {
<a name="line654"></a>                    // 有设置第二个元素则把第二元素作为表前缀
<a name="line655"></a>                    $table = (string) current($join) . $table;
<a name="line656"></a>                } elseif (false === strpos($table, '.')) {
<a name="line657"></a>                    // 加上默认的表前缀
<a name="line658"></a>                    $table = $prefix . $table;
<a name="line659"></a>                }
<a name="line660"></a>            } else {
<a name="line661"></a>                $join = trim($join);
<a name="line662"></a>                if (0 === strpos($join, '__')) {
<a name="line663"></a>                    $table = $this->parseSqlTable($join);
<a name="line664"></a>                } elseif (false === strpos($join, '(') && false === strpos($join, '.') && !empty($prefix) && 0 !== strpos($join, $prefix)) {
<a name="line665"></a>                    // 传入的表名中不带有'('并且不以默认的表前缀开头时加上默认的表前缀
<a name="line666"></a>                    $table = $prefix . $join;
<a name="line667"></a>                } else {
<a name="line668"></a>                    $table = $join;
<a name="line669"></a>                }
<a name="line670"></a>            }
<a name="line671"></a>            if (is_array($condition)) {
<a name="line672"></a>                $condition = implode(' AND ', $condition);
<a name="line673"></a>            }
<a name="line674"></a>            $this->options['join'][] = strtoupper($type) . ' JOIN ' . $table . ' ON ' . $condition;
<a name="line675"></a>        }
<a name="line676"></a>        return $this;
<a name="line677"></a>    }
<a name="line678"></a>
<a name="line679"></a>    /**
<a name="line680"></a>     * 查询SQL组装 union
<a name="line681"></a>     * @access public
<a name="line682"></a>     * @param mixed     $union
<a name="line683"></a>     * @param boolean   $all
<a name="line684"></a>     * @return $this
<a name="line685"></a>     */
<a name="line686"></a>    public function union($union, $all = false)
<a name="line687"></a>    {
<a name="line688"></a>        $this->options['union']['type'] = $all ? 'UNION ALL' : 'UNION';
<a name="line689"></a>
<a name="line690"></a>        if (is_array($union)) {
<a name="line691"></a>            $this->options['union'] = array_merge($this->options['union'], $union);
<a name="line692"></a>        } else {
<a name="line693"></a>            $this->options['union'][] = $union;
<a name="line694"></a>        }
<a name="line695"></a>        return $this;
<a name="line696"></a>    }
<a name="line697"></a>
<a name="line698"></a>    /**
<a name="line699"></a>     * 指定查询字段 支持字段排除和指定数据表
<a name="line700"></a>     * @access public
<a name="line701"></a>     * @param mixed     $field
<a name="line702"></a>     * @param boolean   $except 是否排除
<a name="line703"></a>     * @param string    $tableName 数据表名
<a name="line704"></a>     * @param string    $prefix 字段前缀
<a name="line705"></a>     * @param string    $alias 别名前缀
<a name="line706"></a>     * @return $this
<a name="line707"></a>     */
<a name="line708"></a>    public function field($field, $except = false, $tableName = '', $prefix = '', $alias = '')
<a name="line709"></a>    {
<a name="line710"></a>        if (empty($field)) {
<a name="line711"></a>            return $this;
<a name="line712"></a>        }
<a name="line713"></a>        if (is_string($field)) {
<a name="line714"></a>            $field = array_map('trim', explode(',', $field));
<a name="line715"></a>        }
<a name="line716"></a>        if (true === $field) {
<a name="line717"></a>            // 获取全部字段
<a name="line718"></a>            $fields = $this->getTableInfo($tableName, 'fields');
<a name="line719"></a>            $field  = $fields ?: ['*'];
<a name="line720"></a>        } elseif ($except) {
<a name="line721"></a>            // 字段排除
<a name="line722"></a>            $fields = $this->getTableInfo($tableName, 'fields');
<a name="line723"></a>            $field  = $fields ? array_diff($fields, $field) : $field;
<a name="line724"></a>        }
<a name="line725"></a>        if ($tableName) {
<a name="line726"></a>            // 添加统一的前缀
<a name="line727"></a>            $prefix = $prefix ?: $tableName;
<a name="line728"></a>            foreach ($field as $key => $val) {
<a name="line729"></a>                if (is_numeric($key)) {
<a name="line730"></a>                    $val = $prefix . '.' . $val . ($alias ? ' AS ' . $alias . $val : '');
<a name="line731"></a>                }
<a name="line732"></a>                $field[$key] = $val;
<a name="line733"></a>            }
<a name="line734"></a>        }
<a name="line735"></a>
<a name="line736"></a>        if (isset($this->options['field'])) {
<a name="line737"></a>            $field = array_merge($this->options['field'], $field);
<a name="line738"></a>        }
<a name="line739"></a>        $this->options['field'] = $field;
<a name="line740"></a>        return $this;
<a name="line741"></a>    }
<a name="line742"></a>
<a name="line743"></a>    /**
<a name="line744"></a>     * 指定JOIN查询字段
<a name="line745"></a>     * @access public
<a name="line746"></a>     * @param string|array  $table 数据表
<a name="line747"></a>     * @param string|array  $field 查询字段
<a name="line748"></a>     * @param string|array  $on JOIN条件
<a name="line749"></a>     * @param string        $type JOIN类型
<a name="line750"></a>     * @return $this
<a name="line751"></a>     */
<a name="line752"></a>    public function view($join, $field = null, $on = null, $type = 'INNER')
<a name="line753"></a>    {
<a name="line754"></a>        $this->options['view'] = true;
<a name="line755"></a>        if (is_array($join) && is_null($field)) {
<a name="line756"></a>            foreach ($join as $key => $val) {
<a name="line757"></a>                $this->view($key, $val[0], isset($val[1]) ? $val[1] : null, isset($val[2]) ? $val[2] : 'INNER');
<a name="line758"></a>            }
<a name="line759"></a>        } else {
<a name="line760"></a>            $fields = [];
<a name="line761"></a>            if (is_array($join)) {
<a name="line762"></a>                // 支持数据表别名
<a name="line763"></a>                list($join, $alias, $table) = array_pad($join, 3, '');
<a name="line764"></a>            } else {
<a name="line765"></a>                $alias = $join;
<a name="line766"></a>            }
<a name="line767"></a>            $table = !empty($table) ? $table : $this->getTable($join);
<a name="line768"></a>            if (true === $field) {
<a name="line769"></a>                $fields = $alias . '.*';
<a name="line770"></a>            } else {
<a name="line771"></a>                if (is_string($field)) {
<a name="line772"></a>                    $field = explode(',', $field);
<a name="line773"></a>                }
<a name="line774"></a>                foreach ($field as $key => $val) {
<a name="line775"></a>                    if (is_numeric($key)) {
<a name="line776"></a>                        $fields[]                   = $alias . '.' . $val;
<a name="line777"></a>                        $this->options['map'][$val] = $alias . '.' . $val;
<a name="line778"></a>                    } else {
<a name="line779"></a>                        if (preg_match('/[,=\.\'\"\(\s]/', $key)) {
<a name="line780"></a>                            $name = $key;
<a name="line781"></a>                        } else {
<a name="line782"></a>                            $name = $alias . '.' . $key;
<a name="line783"></a>                        }
<a name="line784"></a>                        $fields[]                   = $name . ' AS ' . $val;
<a name="line785"></a>                        $this->options['map'][$val] = $name;
<a name="line786"></a>                    }
<a name="line787"></a>                }
<a name="line788"></a>            }
<a name="line789"></a>            $this->field($fields);
<a name="line790"></a>            if ($on) {
<a name="line791"></a>                $this->join($table . ' ' . $alias, $on, $type);
<a name="line792"></a>            } else {
<a name="line793"></a>                $this->table($table . ' ' . $alias);
<a name="line794"></a>            }
<a name="line795"></a>        }
<a name="line796"></a>        return $this;
<a name="line797"></a>    }
<a name="line798"></a>
<a name="line799"></a>    /**
<a name="line800"></a>     * 设置分表规则
<a name="line801"></a>     * @access public
<a name="line802"></a>     * @param array     $data 操作的数据
<a name="line803"></a>     * @param string    $field 分表依据的字段
<a name="line804"></a>     * @param array     $rule 分表规则
<a name="line805"></a>     * @return $this
<a name="line806"></a>     */
<a name="line807"></a>    public function partition($data, $field, $rule = [])
<a name="line808"></a>    {
<a name="line809"></a>        $this->options['table'] = $this->getPartitionTableName($data, $field, $rule);
<a name="line810"></a>        return $this;
<a name="line811"></a>    }
<a name="line812"></a>
<a name="line813"></a>    /**
<a name="line814"></a>     * 指定AND查询条件
<a name="line815"></a>     * @access public
<a name="line816"></a>     * @param mixed     $field 查询字段
<a name="line817"></a>     * @param mixed     $op 查询表达式
<a name="line818"></a>     * @param mixed     $condition 查询条件
<a name="line819"></a>     * @return $this
<a name="line820"></a>     */
<a name="line821"></a>    public function where($field, $op = null, $condition = null)
<a name="line822"></a>    {
<a name="line823"></a>        $param = func_get_args();
<a name="line824"></a>        array_shift($param);
<a name="line825"></a>        $this->parseWhereExp('AND', $field, $op, $condition, $param);
<a name="line826"></a>        return $this;
<a name="line827"></a>    }
<a name="line828"></a>
<a name="line829"></a>    /**
<a name="line830"></a>     * 指定OR查询条件
<a name="line831"></a>     * @access public
<a name="line832"></a>     * @param mixed     $field 查询字段
<a name="line833"></a>     * @param mixed     $op 查询表达式
<a name="line834"></a>     * @param mixed     $condition 查询条件
<a name="line835"></a>     * @return $this
<a name="line836"></a>     */
<a name="line837"></a>    public function whereOr($field, $op = null, $condition = null)
<a name="line838"></a>    {
<a name="line839"></a>        $param = func_get_args();
<a name="line840"></a>        array_shift($param);
<a name="line841"></a>        $this->parseWhereExp('OR', $field, $op, $condition, $param);
<a name="line842"></a>        return $this;
<a name="line843"></a>    }
<a name="line844"></a>
<a name="line845"></a>    /**
<a name="line846"></a>     * 指定XOR查询条件
<a name="line847"></a>     * @access public
<a name="line848"></a>     * @param mixed     $field 查询字段
<a name="line849"></a>     * @param mixed     $op 查询表达式
<a name="line850"></a>     * @param mixed     $condition 查询条件
<a name="line851"></a>     * @return $this
<a name="line852"></a>     */
<a name="line853"></a>    public function whereXor($field, $op = null, $condition = null)
<a name="line854"></a>    {
<a name="line855"></a>        $param = func_get_args();
<a name="line856"></a>        array_shift($param);
<a name="line857"></a>        $this->parseWhereExp('XOR', $field, $op, $condition, $param);
<a name="line858"></a>        return $this;
<a name="line859"></a>    }
<a name="line860"></a>
<a name="line861"></a>    /**
<a name="line862"></a>     * 分析查询表达式
<a name="line863"></a>     * @access public
<a name="line864"></a>     * @param string                $logic 查询逻辑 and or xor
<a name="line865"></a>     * @param string|array|\Closure $field 查询字段
<a name="line866"></a>     * @param mixed                 $op 查询表达式
<a name="line867"></a>     * @param mixed                 $condition 查询条件
<a name="line868"></a>     * @param array                 $param 查询参数
<a name="line869"></a>     * @return void
<a name="line870"></a>     */
<a name="line871"></a>    protected function parseWhereExp($logic, $field, $op, $condition, $param = [])
<a name="line872"></a>    {
<a name="line873"></a>        if ($field instanceof \Closure) {
<a name="line874"></a>            $this->options['where'][$logic][] = is_string($op) ? [$op, $field] : $field;
<a name="line875"></a>            return;
<a name="line876"></a>        }
<a name="line877"></a>
<a name="line878"></a>        if (is_string($field) && !empty($this->options['via']) && !strpos($field, '.')) {
<a name="line879"></a>            $field = $this->options['via'] . '.' . $field;
<a name="line880"></a>        }
<a name="line881"></a>        if (is_string($field) && preg_match('/[,=\>\<\'\"\(\s]/', $field)) {
<a name="line882"></a>            $where[] = ['exp', $field];
<a name="line883"></a>            if (is_array($op)) {
<a name="line884"></a>                // 参数绑定
<a name="line885"></a>                $this->bind($op);
<a name="line886"></a>            }
<a name="line887"></a>        } elseif (is_null($op) && is_null($condition)) {
<a name="line888"></a>            if (is_array($field)) {
<a name="line889"></a>                // 数组批量查询
<a name="line890"></a>                $where = $field;
<a name="line891"></a>            } elseif ($field) {
<a name="line892"></a>                // 字符串查询
<a name="line893"></a>                $where[] = ['exp', $field];
<a name="line894"></a>            } else {
<a name="line895"></a>                $where = '';
<a name="line896"></a>            }
<a name="line897"></a>        } elseif (is_array($op)) {
<a name="line898"></a>            $where[$field] = $param;
<a name="line899"></a>        } elseif (in_array(strtolower($op), ['null', 'notnull', 'not null'])) {
<a name="line900"></a>            // null查询
<a name="line901"></a>            $where[$field] = [$op, ''];
<a name="line902"></a>        } elseif (is_null($condition)) {
<a name="line903"></a>            // 字段相等查询
<a name="line904"></a>            $where[$field] = ['eq', $op];
<a name="line905"></a>        } else {
<a name="line906"></a>            $where[$field] = [$op, $condition];
<a name="line907"></a>        }
<a name="line908"></a>        if (!empty($where)) {
<a name="line909"></a>            if (!isset($this->options['where'][$logic])) {
<a name="line910"></a>                $this->options['where'][$logic] = [];
<a name="line911"></a>            }
<a name="line912"></a>            $this->options['where'][$logic] = array_merge($this->options['where'][$logic], $where);
<a name="line913"></a>        }
<a name="line914"></a>    }
<a name="line915"></a>
<a name="line916"></a>    /**
<a name="line917"></a>     * 指定查询数量
<a name="line918"></a>     * @access public
<a name="line919"></a>     * @param mixed $offset 起始位置
<a name="line920"></a>     * @param mixed $length 查询数量
<a name="line921"></a>     * @return $this
<a name="line922"></a>     */
<a name="line923"></a>    public function limit($offset, $length = null)
<a name="line924"></a>    {
<a name="line925"></a>        if (is_null($length) && strpos($offset, ',')) {
<a name="line926"></a>            list($offset, $length) = explode(',', $offset);
<a name="line927"></a>        }
<a name="line928"></a>        $this->options['limit'] = intval($offset) . ($length ? ',' . intval($length) : '');
<a name="line929"></a>        return $this;
<a name="line930"></a>    }
<a name="line931"></a>
<a name="line932"></a>    /**
<a name="line933"></a>     * 指定分页
<a name="line934"></a>     * @access public
<a name="line935"></a>     * @param mixed $page 页数
<a name="line936"></a>     * @param mixed $listRows 每页数量
<a name="line937"></a>     * @return $this
<a name="line938"></a>     */
<a name="line939"></a>    public function page($page, $listRows = null)
<a name="line940"></a>    {
<a name="line941"></a>        if (is_null($listRows) && strpos($page, ',')) {
<a name="line942"></a>            list($page, $listRows) = explode(',', $page);
<a name="line943"></a>        }
<a name="line944"></a>        $this->options['page'] = [intval($page), intval($listRows)];
<a name="line945"></a>        return $this;
<a name="line946"></a>    }
<a name="line947"></a>
<a name="line948"></a>    /**
<a name="line949"></a>     * 分页查询
<a name="line950"></a>     * @param int|null  $listRows 每页数量
<a name="line951"></a>     * @param bool      $simple 简洁模式
<a name="line952"></a>     * @param array     $config 配置参数
<a name="line953"></a>     *                      page:当前页,
<a name="line954"></a>     *                      path:url路径,
<a name="line955"></a>     *                      query:url额外参数,
<a name="line956"></a>     *                      fragment:url锚点,
<a name="line957"></a>     *                      var_page:分页变量,
<a name="line958"></a>     *                      list_rows:每页数量
<a name="line959"></a>     *                      type:分页类名,
<a name="line960"></a>     *                      namespace:分页类命名空间
<a name="line961"></a>     * @return \think\paginator\Collection
<a name="line962"></a>     * @throws DbException
<a name="line963"></a>     */
<a name="line964"></a>    public function paginate($listRows = null, $simple = false, $config = [])
<a name="line965"></a>    {
<a name="line966"></a>        $config   = array_merge(Config::get('paginate'), $config);
<a name="line967"></a>        $listRows = $listRows ?: $config['list_rows'];
<a name="line968"></a>        $class    = false !== strpos($config['type'], '\\') ? $config['type'] : '\\think\\paginator\\driver\\' . ucwords($config['type']);
<a name="line969"></a>        $page     = isset($config['page']) ? (int) $config['page'] : call_user_func([
<a name="line970"></a>            $class,
<a name="line971"></a>            'getCurrentPage',
<a name="line972"></a>        ], $config['var_page']);
<a name="line973"></a>
<a name="line974"></a>        $page = $page < 1 ? 1 : $page;
<a name="line975"></a>
<a name="line976"></a>        $config['path'] = isset($config['path']) ? $config['path'] : call_user_func([$class, 'getCurrentPath']);
<a name="line977"></a>
<a name="line978"></a>        /** @var Paginator $paginator */
<a name="line979"></a>        if (!$simple) {
<a name="line980"></a>            $options = $this->getOptions();
<a name="line981"></a>            $total   = $this->count();
<a name="line982"></a>            $results = $this->options($options)->page($page, $listRows)->select();
<a name="line983"></a>        } else {
<a name="line984"></a>            $results = $this->limit(($page - 1) * $listRows, $listRows + 1)->select();
<a name="line985"></a>            $total   = null;
<a name="line986"></a>        }
<a name="line987"></a>
<a name="line988"></a>        $paginator = new $class($results, $listRows, $page, $simple, $total, $config);
<a name="line989"></a>        return $paginator->items();
<a name="line990"></a>    }
<a name="line991"></a>
<a name="line992"></a>    /**
<a name="line993"></a>     * 指定当前操作的数据表
<a name="line994"></a>     * @access public
<a name="line995"></a>     * @param string $table 表名
<a name="line996"></a>     * @return $this
<a name="line997"></a>     */
<a name="line998"></a>    public function table($table)
<a name="line999"></a>    {
<a name="line1000"></a>        $this->options['table'] = $table;
<a name="line1001"></a>        return $this;
<a name="line1002"></a>    }
<a name="line1003"></a>
<a name="line1004"></a>    /**
<a name="line1005"></a>     * USING支持 用于多表删除
<a name="line1006"></a>     * @access public
<a name="line1007"></a>     * @param mixed $using
<a name="line1008"></a>     * @return $this
<a name="line1009"></a>     */
<a name="line1010"></a>    public function using($using)
<a name="line1011"></a>    {
<a name="line1012"></a>        $this->options['using'] = $using;
<a name="line1013"></a>        return $this;
<a name="line1014"></a>    }
<a name="line1015"></a>
<a name="line1016"></a>    /**
<a name="line1017"></a>     * 指定排序 order('id','desc') 或者 order(['id'=>'desc','create_time'=>'desc'])
<a name="line1018"></a>     * @access public
<a name="line1019"></a>     * @param string|array  $field 排序字段
<a name="line1020"></a>     * @param string        $order 排序
<a name="line1021"></a>     * @return $this
<a name="line1022"></a>     */
<a name="line1023"></a>    public function order($field, $order = null)
<a name="line1024"></a>    {
<a name="line1025"></a>        if (!empty($field)) {
<a name="line1026"></a>            if (is_string($field)) {
<a name="line1027"></a>                if (!empty($this->options['via'])) {
<a name="line1028"></a>                    $field = $this->options['via'] . '.' . $field;
<a name="line1029"></a>                }
<a name="line1030"></a>                $field = empty($order) ? $field : [$field => $order];
<a name="line1031"></a>            } elseif (!empty($this->options['via'])) {
<a name="line1032"></a>                foreach ($field as $key => $val) {
<a name="line1033"></a>                    if (is_numeric($key)) {
<a name="line1034"></a>                        $field[$key] = $this->options['via'] . '.' . $val;
<a name="line1035"></a>                    } else {
<a name="line1036"></a>                        $field[$this->options['via'] . '.' . $key] = $val;
<a name="line1037"></a>                        unset($field[$key]);
<a name="line1038"></a>                    }
<a name="line1039"></a>                }
<a name="line1040"></a>            }
<a name="line1041"></a>            $this->options['order'] = $field;
<a name="line1042"></a>        }
<a name="line1043"></a>        return $this;
<a name="line1044"></a>    }
<a name="line1045"></a>
<a name="line1046"></a>    /**
<a name="line1047"></a>     * 查询缓存
<a name="line1048"></a>     * @access public
<a name="line1049"></a>     * @param mixed     $key 缓存key
<a name="line1050"></a>     * @param integer   $expire 缓存有效期
<a name="line1051"></a>     * @return $this
<a name="line1052"></a>     */
<a name="line1053"></a>    public function cache($key = true, $expire = null)
<a name="line1054"></a>    {
<a name="line1055"></a>        // 增加快捷调用方式 cache(10) 等同于 cache(true, 10)
<a name="line1056"></a>        if (is_numeric($key) && is_null($expire)) {
<a name="line1057"></a>            $expire = $key;
<a name="line1058"></a>            $key    = true;
<a name="line1059"></a>        }
<a name="line1060"></a>        if (false !== $key) {
<a name="line1061"></a>            $this->options['cache'] = ['key' => $key, 'expire' => $expire];
<a name="line1062"></a>        }
<a name="line1063"></a>        return $this;
<a name="line1064"></a>    }
<a name="line1065"></a>
<a name="line1066"></a>    /**
<a name="line1067"></a>     * 指定group查询
<a name="line1068"></a>     * @access public
<a name="line1069"></a>     * @param string $group GROUP
<a name="line1070"></a>     * @return $this
<a name="line1071"></a>     */
<a name="line1072"></a>    public function group($group)
<a name="line1073"></a>    {
<a name="line1074"></a>        $this->options['group'] = $group;
<a name="line1075"></a>        return $this;
<a name="line1076"></a>    }
<a name="line1077"></a>
<a name="line1078"></a>    /**
<a name="line1079"></a>     * 指定having查询
<a name="line1080"></a>     * @access public
<a name="line1081"></a>     * @param string $having having
<a name="line1082"></a>     * @return $this
<a name="line1083"></a>     */
<a name="line1084"></a>    public function having($having)
<a name="line1085"></a>    {
<a name="line1086"></a>        $this->options['having'] = $having;
<a name="line1087"></a>        return $this;
<a name="line1088"></a>    }
<a name="line1089"></a>
<a name="line1090"></a>    /**
<a name="line1091"></a>     * 指定查询lock
<a name="line1092"></a>     * @access public
<a name="line1093"></a>     * @param boolean $lock 是否lock
<a name="line1094"></a>     * @return $this
<a name="line1095"></a>     */
<a name="line1096"></a>    public function lock($lock = false)
<a name="line1097"></a>    {
<a name="line1098"></a>        $this->options['lock']   = $lock;
<a name="line1099"></a>        $this->options['master'] = true;
<a name="line1100"></a>        return $this;
<a name="line1101"></a>    }
<a name="line1102"></a>
<a name="line1103"></a>    /**
<a name="line1104"></a>     * 指定distinct查询
<a name="line1105"></a>     * @access public
<a name="line1106"></a>     * @param string $distinct 是否唯一
<a name="line1107"></a>     * @return $this
<a name="line1108"></a>     */
<a name="line1109"></a>    public function distinct($distinct)
<a name="line1110"></a>    {
<a name="line1111"></a>        $this->options['distinct'] = $distinct;
<a name="line1112"></a>        return $this;
<a name="line1113"></a>    }
<a name="line1114"></a>
<a name="line1115"></a>    /**
<a name="line1116"></a>     * 指定数据表别名
<a name="line1117"></a>     * @access public
<a name="line1118"></a>     * @param string $alias 数据表别名
<a name="line1119"></a>     * @return $this
<a name="line1120"></a>     */
<a name="line1121"></a>    public function alias($alias)
<a name="line1122"></a>    {
<a name="line1123"></a>        $this->options['alias'] = $alias;
<a name="line1124"></a>        return $this;
<a name="line1125"></a>    }
<a name="line1126"></a>
<a name="line1127"></a>    /**
<a name="line1128"></a>     * 指定强制索引
<a name="line1129"></a>     * @access public
<a name="line1130"></a>     * @param string $force 索引名称
<a name="line1131"></a>     * @return $this
<a name="line1132"></a>     */
<a name="line1133"></a>    public function force($force)
<a name="line1134"></a>    {
<a name="line1135"></a>        $this->options['force'] = $force;
<a name="line1136"></a>        return $this;
<a name="line1137"></a>    }
<a name="line1138"></a>
<a name="line1139"></a>    /**
<a name="line1140"></a>     * 查询注释
<a name="line1141"></a>     * @access public
<a name="line1142"></a>     * @param string $comment 注释
<a name="line1143"></a>     * @return $this
<a name="line1144"></a>     */
<a name="line1145"></a>    public function comment($comment)
<a name="line1146"></a>    {
<a name="line1147"></a>        $this->options['comment'] = $comment;
<a name="line1148"></a>        return $this;
<a name="line1149"></a>    }
<a name="line1150"></a>
<a name="line1151"></a>    /**
<a name="line1152"></a>     * 获取执行的SQL语句
<a name="line1153"></a>     * @access public
<a name="line1154"></a>     * @param boolean $fetch 是否返回sql
<a name="line1155"></a>     * @return $this
<a name="line1156"></a>     */
<a name="line1157"></a>    public function fetchSql($fetch = true)
<a name="line1158"></a>    {
<a name="line1159"></a>        $this->options['fetch_sql'] = $fetch;
<a name="line1160"></a>        return $this;
<a name="line1161"></a>    }
<a name="line1162"></a>
<a name="line1163"></a>    /**
<a name="line1164"></a>     * 不主动获取数据集
<a name="line1165"></a>     * @access public
<a name="line1166"></a>     * @param bool $pdo 是否返回 PDOStatement 对象
<a name="line1167"></a>     * @return $this
<a name="line1168"></a>     */
<a name="line1169"></a>    public function fetchPdo($pdo = true)
<a name="line1170"></a>    {
<a name="line1171"></a>        $this->options['fetch_class'] = $pdo;
<a name="line1172"></a>        return $this;
<a name="line1173"></a>    }
<a name="line1174"></a>
<a name="line1175"></a>    /**
<a name="line1176"></a>     * 指定数据集返回对象
<a name="line1177"></a>     * @access public
<a name="line1178"></a>     * @param string $class 指定返回的数据集对象类名
<a name="line1179"></a>     * @return $this
<a name="line1180"></a>     */
<a name="line1181"></a>    public function fetchClass($class)
<a name="line1182"></a>    {
<a name="line1183"></a>        $this->options['fetch_class'] = $class;
<a name="line1184"></a>        return $this;
<a name="line1185"></a>    }
<a name="line1186"></a>
<a name="line1187"></a>    /**
<a name="line1188"></a>     * 设置从主服务器读取数据
<a name="line1189"></a>     * @access public
<a name="line1190"></a>     * @return $this
<a name="line1191"></a>     */
<a name="line1192"></a>    public function master()
<a name="line1193"></a>    {
<a name="line1194"></a>        $this->options['master'] = true;
<a name="line1195"></a>        return $this;
<a name="line1196"></a>    }
<a name="line1197"></a>
<a name="line1198"></a>    /**
<a name="line1199"></a>     * 设置是否严格检查字段名
<a name="line1200"></a>     * @access public
<a name="line1201"></a>     * @param bool $strict 是否严格检查字段
<a name="line1202"></a>     * @return $this
<a name="line1203"></a>     */
<a name="line1204"></a>    public function strict($strict = true)
<a name="line1205"></a>    {
<a name="line1206"></a>        $this->options['strict'] = $strict;
<a name="line1207"></a>        return $this;
<a name="line1208"></a>    }
<a name="line1209"></a>
<a name="line1210"></a>    /**
<a name="line1211"></a>     * 设置查询数据不存在是否抛出异常
<a name="line1212"></a>     * @access public
<a name="line1213"></a>     * @param bool $fail 是否严格检查字段
<a name="line1214"></a>     * @return $this
<a name="line1215"></a>     */
<a name="line1216"></a>    public function failException($fail = true)
<a name="line1217"></a>    {
<a name="line1218"></a>        $this->options['fail'] = $fail;
<a name="line1219"></a>        return $this;
<a name="line1220"></a>    }
<a name="line1221"></a>
<a name="line1222"></a>    /**
<a name="line1223"></a>     * 设置自增序列名
<a name="line1224"></a>     * @access public
<a name="line1225"></a>     * @param string $sequence 自增序列名
<a name="line1226"></a>     * @return $this
<a name="line1227"></a>     */
<a name="line1228"></a>    public function sequence($sequence = null)
<a name="line1229"></a>    {
<a name="line1230"></a>        $this->options['sequence'] = $sequence;
<a name="line1231"></a>        return $this;
<a name="line1232"></a>    }
<a name="line1233"></a>
<a name="line1234"></a>    /**
<a name="line1235"></a>     * 查询日期或者时间
<a name="line1236"></a>     * @access public
<a name="line1237"></a>     * @param string        $field 日期字段名
<a name="line1238"></a>     * @param string        $op 比较运算符或者表达式
<a name="line1239"></a>     * @param string|array  $range 比较范围
<a name="line1240"></a>     * @return $this
<a name="line1241"></a>     */
<a name="line1242"></a>    public function whereTime($field, $op, $range = null)
<a name="line1243"></a>    {
<a name="line1244"></a>        if (is_null($range)) {
<a name="line1245"></a>            // 使用日期表达式
<a name="line1246"></a>            $date = getdate();
<a name="line1247"></a>            switch (strtolower($op)) {
<a name="line1248"></a>                case 'today':
<a name="line1249"></a>                case 'd':
<a name="line1250"></a>                    $range = 'today';
<a name="line1251"></a>                    break;
<a name="line1252"></a>                case 'week':
<a name="line1253"></a>                case 'w':
<a name="line1254"></a>                    $range = 'this week 00:00:00';
<a name="line1255"></a>                    break;
<a name="line1256"></a>                case 'month':
<a name="line1257"></a>                case 'm':
<a name="line1258"></a>                    $range = mktime(0, 0, 0, $date['mon'], 1, $date['year']);
<a name="line1259"></a>                    break;
<a name="line1260"></a>                case 'year':
<a name="line1261"></a>                case 'y':
<a name="line1262"></a>                    $range = mktime(0, 0, 0, 1, 1, $date['year']);
<a name="line1263"></a>                    break;
<a name="line1264"></a>                case 'yesterday':
<a name="line1265"></a>                    $range = ['yesterday', 'today'];
<a name="line1266"></a>                    break;
<a name="line1267"></a>                case 'last week':
<a name="line1268"></a>                    $range = ['last week 00:00:00', 'this week 00:00:00'];
<a name="line1269"></a>                    break;
<a name="line1270"></a>                case 'last month':
<a name="line1271"></a>                    $range = [date('y-m-01', strtotime('-1 month')), mktime(0, 0, 0, $date['mon'], 1, $date['year'])];
<a name="line1272"></a>                    break;
<a name="line1273"></a>                case 'last year':
<a name="line1274"></a>                    $range = [mktime(0, 0, 0, 1, 1, $date['year'] - 1), mktime(0, 0, 0, 1, 1, $date['year'])];
<a name="line1275"></a>                    break;
<a name="line1276"></a>            }
<a name="line1277"></a>            $op = is_array($range) ? 'between' : '>';
<a name="line1278"></a>        }
<a name="line1279"></a>        $this->where($field, strtolower($op) . ' time', $range);
<a name="line1280"></a>        return $this;
<a name="line1281"></a>    }
<a name="line1282"></a>
<a name="line1283"></a>    /**
<a name="line1284"></a>     * 获取数据表信息
<a name="line1285"></a>     * @access public
<a name="line1286"></a>     * @param string $tableName 数据表名 留空自动获取
<a name="line1287"></a>     * @param string $fetch 获取信息类型 包括 fields type bind pk
<a name="line1288"></a>     * @return mixed
<a name="line1289"></a>     */
<a name="line1290"></a>    public function getTableInfo($tableName = '', $fetch = '')
<a name="line1291"></a>    {
<a name="line1292"></a>        if (!$tableName) {
<a name="line1293"></a>            $tableName = $this->getTable();
<a name="line1294"></a>        }
<a name="line1295"></a>        if (is_array($tableName)) {
<a name="line1296"></a>            $tableName = key($tableName) ?: current($tableName);
<a name="line1297"></a>        }
<a name="line1298"></a>
<a name="line1299"></a>        if (strpos($tableName, ',')) {
<a name="line1300"></a>            // 多表不获取字段信息
<a name="line1301"></a>            return false;
<a name="line1302"></a>        } else {
<a name="line1303"></a>            $tableName = $this->parseSqlTable($tableName);
<a name="line1304"></a>        }
<a name="line1305"></a>
<a name="line1306"></a>        $guid = $tableName;
<a name="line1307"></a>        if (!isset($this->info[$guid])) {
<a name="line1308"></a>            $info   = $this->connection->getFields($tableName);
<a name="line1309"></a>            $fields = array_keys($info);
<a name="line1310"></a>            $bind   = $type   = [];
<a name="line1311"></a>            foreach ($info as $key => $val) {
<a name="line1312"></a>                // 记录字段类型
<a name="line1313"></a>                $type[$key] = $val['type'];
<a name="line1314"></a>                if (preg_match('/(int|double|float|decimal|real|numeric|serial)/is', $val['type'])) {
<a name="line1315"></a>                    $bind[$key] = PDO::PARAM_INT;
<a name="line1316"></a>                } elseif (preg_match('/bool/is', $val['type'])) {
<a name="line1317"></a>                    $bind[$key] = PDO::PARAM_BOOL;
<a name="line1318"></a>                } else {
<a name="line1319"></a>                    $bind[$key] = PDO::PARAM_STR;
<a name="line1320"></a>                }
<a name="line1321"></a>                if (!empty($val['primary'])) {
<a name="line1322"></a>                    $pk[] = $key;
<a name="line1323"></a>                }
<a name="line1324"></a>            }
<a name="line1325"></a>            if (isset($pk)) {
<a name="line1326"></a>                // 设置主键
<a name="line1327"></a>                $pk = count($pk) > 1 ? $pk : $pk[0];
<a name="line1328"></a>            } else {
<a name="line1329"></a>                $pk = null;
<a name="line1330"></a>            }
<a name="line1331"></a>            $this->info[$guid] = ['fields' => $fields, 'type' => $type, 'bind' => $bind, 'pk' => $pk];
<a name="line1332"></a>        }
<a name="line1333"></a>        return $fetch ? $this->info[$guid][$fetch] : $this->info[$guid];
<a name="line1334"></a>    }
<a name="line1335"></a>
<a name="line1336"></a>    /**
<a name="line1337"></a>     * 获取当前数据表的主键
<a name="line1338"></a>     * @access public
<a name="line1339"></a>     * @param string $table 数据表名
<a name="line1340"></a>     * @return string|array
<a name="line1341"></a>     */
<a name="line1342"></a>    public function getPk($table = '')
<a name="line1343"></a>    {
<a name="line1344"></a>        return $this->getTableInfo($table, 'pk');
<a name="line1345"></a>    }
<a name="line1346"></a>
<a name="line1347"></a>    /**
<a name="line1348"></a>     * 参数绑定
<a name="line1349"></a>     * @access public
<a name="line1350"></a>     * @param mixed     $key 参数名
<a name="line1351"></a>     * @param mixed     $value 绑定变量值
<a name="line1352"></a>     * @param integer   $type 绑定类型
<a name="line1353"></a>     * @return $this
<a name="line1354"></a>     */
<a name="line1355"></a>    public function bind($key, $value = false, $type = PDO::PARAM_STR)
<a name="line1356"></a>    {
<a name="line1357"></a>        if (is_array($key)) {
<a name="line1358"></a>            $this->bind = array_merge($this->bind, $key);
<a name="line1359"></a>        } else {
<a name="line1360"></a>            $this->bind[$key] = [$value, $type];
<a name="line1361"></a>        }
<a name="line1362"></a>        return $this;
<a name="line1363"></a>    }
<a name="line1364"></a>
<a name="line1365"></a>    /**
<a name="line1366"></a>     * 检测参数是否已经绑定
<a name="line1367"></a>     * @access public
<a name="line1368"></a>     * @param string $key 参数名
<a name="line1369"></a>     * @return bool
<a name="line1370"></a>     */
<a name="line1371"></a>    public function isBind($key)
<a name="line1372"></a>    {
<a name="line1373"></a>        return isset($this->bind[$key]);
<a name="line1374"></a>    }
<a name="line1375"></a>
<a name="line1376"></a>    /**
<a name="line1377"></a>     * 查询参数赋值
<a name="line1378"></a>     * @access protected
<a name="line1379"></a>     * @param array $options 表达式参数
<a name="line1380"></a>     * @return $this
<a name="line1381"></a>     */
<a name="line1382"></a>    protected function options(array $options)
<a name="line1383"></a>    {
<a name="line1384"></a>        $this->options = $options;
<a name="line1385"></a>        return $this;
<a name="line1386"></a>    }
<a name="line1387"></a>
<a name="line1388"></a>    /**
<a name="line1389"></a>     * 获取当前的查询参数
<a name="line1390"></a>     * @access public
<a name="line1391"></a>     * @param string $name 参数名
<a name="line1392"></a>     * @return mixed
<a name="line1393"></a>     */
<a name="line1394"></a>    public function getOptions($name = '')
<a name="line1395"></a>    {
<a name="line1396"></a>        return isset($this->options[$name]) ? $this->options[$name] : $this->options;
<a name="line1397"></a>    }
<a name="line1398"></a>
<a name="line1399"></a>    /**
<a name="line1400"></a>     * 设置关联查询JOIN预查询
<a name="line1401"></a>     * @access public
<a name="line1402"></a>     * @param string|array $with 关联方法名称
<a name="line1403"></a>     * @return $this
<a name="line1404"></a>     */
<a name="line1405"></a>    public function with($with)
<a name="line1406"></a>    {
<a name="line1407"></a>        if (empty($with)) {
<a name="line1408"></a>            return $this;
<a name="line1409"></a>        }
<a name="line1410"></a>
<a name="line1411"></a>        if (is_string($with)) {
<a name="line1412"></a>            $with = explode(',', $with);
<a name="line1413"></a>        }
<a name="line1414"></a>
<a name="line1415"></a>        $i            = 0;
<a name="line1416"></a>        $currentModel = $this->model;
<a name="line1417"></a>
<a name="line1418"></a>        /** @var Model $class */
<a name="line1419"></a>        $class = new $currentModel;
<a name="line1420"></a>        foreach ($with as $key => $relation) {
<a name="line1421"></a>            $closure = false;
<a name="line1422"></a>            if ($relation instanceof \Closure) {
<a name="line1423"></a>                // 支持闭包查询过滤关联条件
<a name="line1424"></a>                $closure    = $relation;
<a name="line1425"></a>                $relation   = $key;
<a name="line1426"></a>                $with[$key] = $key;
<a name="line1427"></a>            } elseif (is_string($relation) && strpos($relation, '.')) {
<a name="line1428"></a>                $with[$key]                   = $relation;
<a name="line1429"></a>                list($relation, $subRelation) = explode('.', $relation, 2);
<a name="line1430"></a>            }
<a name="line1431"></a>
<a name="line1432"></a>            /** @var Relation $model */
<a name="line1433"></a>            $model = $class->$relation();
<a name="line1434"></a>            $info  = $model->getRelationInfo();
<a name="line1435"></a>            if (in_array($info['type'], [Relation::HAS_ONE, Relation::BELONGS_TO])) {
<a name="line1436"></a>                if (0 == $i) {
<a name="line1437"></a>                    $name  = Loader::parseName(basename(str_replace('\\', '/', $currentModel)));
<a name="line1438"></a>                    $table = $this->getTable();
<a name="line1439"></a>                    $alias = isset($info['alias'][$name]) ? $info['alias'][$name] : $name;
<a name="line1440"></a>                    $this->table($table)->alias($alias);
<a name="line1441"></a>                    if (isset($this->options['field'])) {
<a name="line1442"></a>                        $field = $this->options['field'];
<a name="line1443"></a>                        unset($this->options['field']);
<a name="line1444"></a>                    } else {
<a name="line1445"></a>                        $field = true;
<a name="line1446"></a>                    }
<a name="line1447"></a>                    $this->field($field, false, $table, $alias);
<a name="line1448"></a>                }
<a name="line1449"></a>                // 预载入封装
<a name="line1450"></a>                $joinTable = $model->getTable();
<a name="line1451"></a>                $joinName  = Loader::parseName(basename(str_replace('\\', '/', $info['model'])));
<a name="line1452"></a>                $joinAlias = isset($info['alias'][$joinName]) ? $info['alias'][$joinName] : $joinName;
<a name="line1453"></a>                $this->via($joinAlias);
<a name="line1454"></a>
<a name="line1455"></a>                if (Relation::HAS_ONE == $info['type']) {
<a name="line1456"></a>                    $this->join($joinTable . ' ' . $joinAlias, $alias . '.' . $info['localKey'] . '=' . $joinAlias . '.' . $info['foreignKey'], $info['joinType']);
<a name="line1457"></a>                } else {
<a name="line1458"></a>                    $this->join($joinTable . ' ' . $joinAlias, $alias . '.' . $info['foreignKey'] . '=' . $joinAlias . '.' . $info['localKey'], $info['joinType']);
<a name="line1459"></a>                }
<a name="line1460"></a>
<a name="line1461"></a>                if ($closure) {
<a name="line1462"></a>                    // 执行闭包查询
<a name="line1463"></a>                    call_user_func_array($closure, [ & $this]);
<a name="line1464"></a>                    //指定获取关联的字段
<a name="line1465"></a>                    //需要在 回调中 调方法 withField 方法，如
<a name="line1466"></a>                    // $query->where(['id'=>1])->withField('id,name');
<a name="line1467"></a>                    if (!empty($this->options['with_field'])) {
<a name="line1468"></a>                        $field = $this->options['with_field'];
<a name="line1469"></a>                        unset($this->options['with_field']);
<a name="line1470"></a>                    }
<a name="line1471"></a>                }
<a name="line1472"></a>                $this->field($field, false, $joinTable, $joinAlias, $relation . '__');
<a name="line1473"></a>                $i++;
<a name="line1474"></a>            } elseif ($closure) {
<a name="line1475"></a>                $with[$key] = $closure;
<a name="line1476"></a>            }
<a name="line1477"></a>        }
<a name="line1478"></a>        $this->via();
<a name="line1479"></a>        $this->options['with'] = $with;
<a name="line1480"></a>        return $this;
<a name="line1481"></a>    }
<a name="line1482"></a>
<a name="line1483"></a>    /**
<a name="line1484"></a>     * 关联预加载中 获取关联指定字段值
<a name="line1485"></a>     * example:
<a name="line1486"></a>     * Model::with(['relation' => function($query){
<a name="line1487"></a>     *     $query->withField("id,name");
<a name="line1488"></a>     * }])
<a name="line1489"></a>     *
<a name="line1490"></a>     * @param string | array $field 指定获取的字段
<a name="line1491"></a>     * @return $this
<a name="line1492"></a>     */
<a name="line1493"></a>    public function withField($field)
<a name="line1494"></a>    {
<a name="line1495"></a>        $this->options['with_field'] = $field;
<a name="line1496"></a>        return $this;
<a name="line1497"></a>    }
<a name="line1498"></a>
<a name="line1499"></a>    /**
<a name="line1500"></a>     * 设置当前字段添加的表别名
<a name="line1501"></a>     * @access public
<a name="line1502"></a>     * @param string $via
<a name="line1503"></a>     * @return $this
<a name="line1504"></a>     */
<a name="line1505"></a>    public function via($via = '')
<a name="line1506"></a>    {
<a name="line1507"></a>        $this->options['via'] = $via;
<a name="line1508"></a>        return $this;
<a name="line1509"></a>    }
<a name="line1510"></a>
<a name="line1511"></a>    /**
<a name="line1512"></a>     * 设置关联查询
<a name="line1513"></a>     * @access public
<a name="line1514"></a>     * @param string $relation 关联名称
<a name="line1515"></a>     * @return $this
<a name="line1516"></a>     */
<a name="line1517"></a>    public function relation($relation)
<a name="line1518"></a>    {
<a name="line1519"></a>        $this->options['relation'] = $relation;
<a name="line1520"></a>        return $this;
<a name="line1521"></a>    }
<a name="line1522"></a>
<a name="line1523"></a>    /**
<a name="line1524"></a>     * 把主键值转换为查询条件 支持复合主键
<a name="line1525"></a>     * @access public
<a name="line1526"></a>     * @param array|string  $data 主键数据
<a name="line1527"></a>     * @param mixed         $options 表达式参数
<a name="line1528"></a>     * @return void
<a name="line1529"></a>     * @throws Exception
<a name="line1530"></a>     */
<a name="line1531"></a>    protected function parsePkWhere($data, &$options)
<a name="line1532"></a>    {
<a name="line1533"></a>        $pk = $this->getPk($options['table']);
<a name="line1534"></a>        // 获取当前数据表
<a name="line1535"></a>        if (!empty($options['alias'])) {
<a name="line1536"></a>            $alias = $options['alias'];
<a name="line1537"></a>        }
<a name="line1538"></a>        if (is_string($pk)) {
<a name="line1539"></a>            $key = isset($alias) ? $alias . '.' . $pk : $pk;
<a name="line1540"></a>            // 根据主键查询
<a name="line1541"></a>            if (is_array($data)) {
<a name="line1542"></a>                $where[$key] = isset($data[$pk]) ? $data[$pk] : ['in', $data];
<a name="line1543"></a>            } else {
<a name="line1544"></a>                $where[$key] = strpos($data, ',') ? ['IN', $data] : $data;
<a name="line1545"></a>            }
<a name="line1546"></a>        } elseif (is_array($pk) && is_array($data) && !empty($data)) {
<a name="line1547"></a>            // 根据复合主键查询
<a name="line1548"></a>            foreach ($pk as $key) {
<a name="line1549"></a>                if (isset($data[$key])) {
<a name="line1550"></a>                    $attr         = isset($alias) ? $alias . '.' . $key : $key;
<a name="line1551"></a>                    $where[$attr] = $data[$key];
<a name="line1552"></a>                } else {
<a name="line1553"></a>                    throw new Exception('miss complex primary data');
<a name="line1554"></a>                }
<a name="line1555"></a>            }
<a name="line1556"></a>        }
<a name="line1557"></a>
<a name="line1558"></a>        if (!empty($where)) {
<a name="line1559"></a>            if (isset($options['where']['AND'])) {
<a name="line1560"></a>                $options['where']['AND'] = array_merge($options['where']['AND'], $where);
<a name="line1561"></a>            } else {
<a name="line1562"></a>                $options['where']['AND'] = $where;
<a name="line1563"></a>            }
<a name="line1564"></a>        }
<a name="line1565"></a>        return;
<a name="line1566"></a>    }
<a name="line1567"></a>
<a name="line1568"></a>    /**
<a name="line1569"></a>     * 插入记录
<a name="line1570"></a>     * @access public
<a name="line1571"></a>     * @param mixed     $data 数据
<a name="line1572"></a>     * @param boolean   $replace 是否replace
<a name="line1573"></a>     * @param boolean   $getLastInsID 是否获取自增ID
<a name="line1574"></a>     * @param string    $sequence 自增序列名
<a name="line1575"></a>     * @return integer|string
<a name="line1576"></a>     */
<a name="line1577"></a>    public function insert(array $data, $replace = false, $getLastInsID = false, $sequence = null)
<a name="line1578"></a>    {
<a name="line1579"></a>        // 分析查询表达式
<a name="line1580"></a>        $options = $this->parseExpress();
<a name="line1581"></a>        // 生成SQL语句
<a name="line1582"></a>        $sql = $this->builder()->insert($data, $options, $replace);
<a name="line1583"></a>        if ($options['fetch_sql']) {
<a name="line1584"></a>            // 获取实际执行的SQL语句
<a name="line1585"></a>            return $this->connection->getRealSql($sql, $this->bind);
<a name="line1586"></a>        }
<a name="line1587"></a>        $sequence = $sequence ?: (isset($options['sequence']) ? $options['sequence'] : null);
<a name="line1588"></a>        // 执行操作
<a name="line1589"></a>        return $this->execute($sql, $this->getBind(), $getLastInsID, $sequence);
<a name="line1590"></a>    }
<a name="line1591"></a>
<a name="line1592"></a>    /**
<a name="line1593"></a>     * 插入记录并获取自增ID
<a name="line1594"></a>     * @access public
<a name="line1595"></a>     * @param mixed     $data 数据
<a name="line1596"></a>     * @param boolean   $replace 是否replace
<a name="line1597"></a>     * @param string    $sequence 自增序列名
<a name="line1598"></a>     * @return integer|string
<a name="line1599"></a>     */
<a name="line1600"></a>    public function insertGetId(array $data, $replace = false, $sequence = null)
<a name="line1601"></a>    {
<a name="line1602"></a>        return $this->insert($data, $replace, true, $sequence);
<a name="line1603"></a>    }
<a name="line1604"></a>
<a name="line1605"></a>    /**
<a name="line1606"></a>     * 批量插入记录
<a name="line1607"></a>     * @access public
<a name="line1608"></a>     * @param mixed $dataSet 数据集
<a name="line1609"></a>     * @return integer|string
<a name="line1610"></a>     */
<a name="line1611"></a>    public function insertAll(array $dataSet)
<a name="line1612"></a>    {
<a name="line1613"></a>        // 分析查询表达式
<a name="line1614"></a>        $options = $this->parseExpress();
<a name="line1615"></a>        if (!is_array(reset($dataSet))) {
<a name="line1616"></a>            return false;
<a name="line1617"></a>        }
<a name="line1618"></a>        // 生成SQL语句
<a name="line1619"></a>        $sql = $this->builder()->insertAll($dataSet, $options);
<a name="line1620"></a>        if ($options['fetch_sql']) {
<a name="line1621"></a>            // 获取实际执行的SQL语句
<a name="line1622"></a>            return $this->connection->getRealSql($sql, $this->bind);
<a name="line1623"></a>        } else {
<a name="line1624"></a>            // 执行操作
<a name="line1625"></a>            return $this->execute($sql, $this->getBind());
<a name="line1626"></a>        }
<a name="line1627"></a>    }
<a name="line1628"></a>
<a name="line1629"></a>    /**
<a name="line1630"></a>     * 通过Select方式插入记录
<a name="line1631"></a>     * @access public
<a name="line1632"></a>     * @param string    $fields 要插入的数据表字段名
<a name="line1633"></a>     * @param string    $table 要插入的数据表名
<a name="line1634"></a>     * @return integer|string
<a name="line1635"></a>     * @throws PDOException
<a name="line1636"></a>     */
<a name="line1637"></a>    public function selectInsert($fields, $table)
<a name="line1638"></a>    {
<a name="line1639"></a>        // 分析查询表达式
<a name="line1640"></a>        $options = $this->parseExpress();
<a name="line1641"></a>        // 生成SQL语句
<a name="line1642"></a>        $table = $this->parseSqlTable($table);
<a name="line1643"></a>        $sql   = $this->builder()->selectInsert($fields, $table, $options);
<a name="line1644"></a>        if ($options['fetch_sql']) {
<a name="line1645"></a>            // 获取实际执行的SQL语句
<a name="line1646"></a>            return $this->connection->getRealSql($sql, $this->bind);
<a name="line1647"></a>        } else {
<a name="line1648"></a>            // 执行操作
<a name="line1649"></a>            return $this->execute($sql, $this->getBind());
<a name="line1650"></a>        }
<a name="line1651"></a>    }
<a name="line1652"></a>
<a name="line1653"></a>    /**
<a name="line1654"></a>     * 更新记录
<a name="line1655"></a>     * @access public
<a name="line1656"></a>     * @param mixed $data 数据
<a name="line1657"></a>     * @return integer|string
<a name="line1658"></a>     * @throws Exception
<a name="line1659"></a>     * @throws PDOException
<a name="line1660"></a>     */
<a name="line1661"></a>    public function update(array $data)
<a name="line1662"></a>    {
<a name="line1663"></a>        $options = $this->parseExpress();
<a name="line1664"></a>        if (empty($options['where'])) {
<a name="line1665"></a>            $pk = $this->getPk($options['table']);
<a name="line1666"></a>            // 如果存在主键数据 则自动作为更新条件
<a name="line1667"></a>            if (is_string($pk) && isset($data[$pk])) {
<a name="line1668"></a>                $where[$pk] = $data[$pk];
<a name="line1669"></a>                $key        = 'think:' . $options['table'] . '|' . $data[$pk];
<a name="line1670"></a>                unset($data[$pk]);
<a name="line1671"></a>            } elseif (is_array($pk)) {
<a name="line1672"></a>                // 增加复合主键支持
<a name="line1673"></a>                foreach ($pk as $field) {
<a name="line1674"></a>                    if (isset($data[$field])) {
<a name="line1675"></a>                        $where[$field] = $data[$field];
<a name="line1676"></a>                    } else {
<a name="line1677"></a>                        // 如果缺少复合主键数据则不执行
<a name="line1678"></a>                        throw new Exception('miss complex primary data');
<a name="line1679"></a>                    }
<a name="line1680"></a>                    unset($data[$field]);
<a name="line1681"></a>                }
<a name="line1682"></a>            }
<a name="line1683"></a>            if (!isset($where)) {
<a name="line1684"></a>                // 如果没有任何更新条件则不执行
<a name="line1685"></a>                throw new Exception('miss update condition');
<a name="line1686"></a>            } else {
<a name="line1687"></a>                $options['where']['AND'] = $where;
<a name="line1688"></a>            }
<a name="line1689"></a>        }
<a name="line1690"></a>        // 生成UPDATE SQL语句
<a name="line1691"></a>        $sql = $this->builder()->update($data, $options);
<a name="line1692"></a>        if ($options['fetch_sql']) {
<a name="line1693"></a>            // 获取实际执行的SQL语句
<a name="line1694"></a>            return $this->connection->getRealSql($sql, $this->bind);
<a name="line1695"></a>        } else {
<a name="line1696"></a>            // 检测缓存
<a name="line1697"></a>            if (isset($key) && Cache::get($key)) {
<a name="line1698"></a>                // 删除缓存
<a name="line1699"></a>                Cache::rm($key);
<a name="line1700"></a>            }
<a name="line1701"></a>            // 执行操作
<a name="line1702"></a>            return '' == $sql ? 0 : $this->execute($sql, $this->getBind());
<a name="line1703"></a>        }
<a name="line1704"></a>    }
<a name="line1705"></a>
<a name="line1706"></a>    /**
<a name="line1707"></a>     * 查找记录
<a name="line1708"></a>     * @access public
<a name="line1709"></a>     * @param array|string|Query|\Closure $data
<a name="line1710"></a>     * @return Collection|false|\PDOStatement|string
<a name="line1711"></a>     * @throws DbException
<a name="line1712"></a>     * @throws Exception
<a name="line1713"></a>     * @throws PDOException
<a name="line1714"></a>     */
<a name="line1715"></a>    public function select($data = null)
<a name="line1716"></a>    {
<a name="line1717"></a>        if ($data instanceof Query) {
<a name="line1718"></a>            return $data->select();
<a name="line1719"></a>        } elseif ($data instanceof \Closure) {
<a name="line1720"></a>            call_user_func_array($data, [ & $this]);
<a name="line1721"></a>            $data = null;
<a name="line1722"></a>        }
<a name="line1723"></a>        // 分析查询表达式
<a name="line1724"></a>        $options = $this->parseExpress();
<a name="line1725"></a>
<a name="line1726"></a>        if (false === $data) {
<a name="line1727"></a>            // 用于子查询 不查询只返回SQL
<a name="line1728"></a>            $options['fetch_sql'] = true;
<a name="line1729"></a>        } elseif (!is_null($data)) {
<a name="line1730"></a>            // 主键条件分析
<a name="line1731"></a>            $this->parsePkWhere($data, $options);
<a name="line1732"></a>        }
<a name="line1733"></a>
<a name="line1734"></a>        $resultSet = false;
<a name="line1735"></a>        if (empty($options['fetch_sql']) && !empty($options['cache'])) {
<a name="line1736"></a>            // 判断查询缓存
<a name="line1737"></a>            $cache     = $options['cache'];
<a name="line1738"></a>            $key       = is_string($cache['key']) ? $cache['key'] : md5(serialize($options));
<a name="line1739"></a>            $resultSet = Cache::get($key);
<a name="line1740"></a>        }
<a name="line1741"></a>        if (!$resultSet) {
<a name="line1742"></a>            // 生成查询SQL
<a name="line1743"></a>            $sql = $this->builder()->select($options);
<a name="line1744"></a>            if ($options['fetch_sql']) {
<a name="line1745"></a>                // 获取实际执行的SQL语句
<a name="line1746"></a>                return $this->connection->getRealSql($sql, $this->bind);
<a name="line1747"></a>            }
<a name="line1748"></a>            // 执行查询操作
<a name="line1749"></a>            $resultSet = $this->query($sql, $this->getBind(), $options['master'], $options['fetch_class']);
<a name="line1750"></a>
<a name="line1751"></a>            if ($resultSet instanceof \PDOStatement) {
<a name="line1752"></a>                // 返回PDOStatement对象
<a name="line1753"></a>                return $resultSet;
<a name="line1754"></a>            }
<a name="line1755"></a>
<a name="line1756"></a>            if (isset($cache)) {
<a name="line1757"></a>                // 缓存数据集
<a name="line1758"></a>                Cache::set($key, $resultSet, $cache['expire']);
<a name="line1759"></a>            }
<a name="line1760"></a>        }
<a name="line1761"></a>
<a name="line1762"></a>        // 返回结果处理
<a name="line1763"></a>        if ($resultSet) {
<a name="line1764"></a>            // 数据列表读取后的处理
<a name="line1765"></a>            if (!empty($this->model)) {
<a name="line1766"></a>                // 生成模型对象
<a name="line1767"></a>                $model = $this->model;
<a name="line1768"></a>                foreach ($resultSet as $key => $result) {
<a name="line1769"></a>                    /** @var Model $result */
<a name="line1770"></a>                    $result = new $model($result);
<a name="line1771"></a>                    $result->isUpdate(true);
<a name="line1772"></a>                    // 关联查询
<a name="line1773"></a>                    if (!empty($options['relation'])) {
<a name="line1774"></a>                        $result->relationQuery($options['relation']);
<a name="line1775"></a>                    }
<a name="line1776"></a>                    $resultSet[$key] = $result;
<a name="line1777"></a>                }
<a name="line1778"></a>                if (!empty($options['with'])) {
<a name="line1779"></a>                    // 预载入
<a name="line1780"></a>                    $resultSet = $result->eagerlyResultSet($resultSet, $options['with'], is_object($resultSet) ? get_class($resultSet) : '');
<a name="line1781"></a>                }
<a name="line1782"></a>            }
<a name="line1783"></a>        } elseif (!empty($options['fail'])) {
<a name="line1784"></a>            if (!empty($this->model)) {
<a name="line1785"></a>                throw new ModelNotFoundException('model data Not Found:' . $this->model, $this->model, $options);
<a name="line1786"></a>            } else {
<a name="line1787"></a>                throw new DataNotFoundException('table data not Found:' . $options['table'], $options['table'], $options);
<a name="line1788"></a>            }
<a name="line1789"></a>        }
<a name="line1790"></a>        return $resultSet;
<a name="line1791"></a>    }
<a name="line1792"></a>
<a name="line1793"></a>    /**
<a name="line1794"></a>     * 查找单条记录
<a name="line1795"></a>     * @access public
<a name="line1796"></a>     * @param array|string|Query|\Closure $data
<a name="line1797"></a>     * @return array|false|\PDOStatement|string|Model
<a name="line1798"></a>     * @throws DbException
<a name="line1799"></a>     * @throws Exception
<a name="line1800"></a>     * @throws PDOException
<a name="line1801"></a>     */
<a name="line1802"></a>    public function find($data = null)
<a name="line1803"></a>    {
<a name="line1804"></a>        if ($data instanceof Query) {
<a name="line1805"></a>            return $data->find();
<a name="line1806"></a>        } elseif ($data instanceof \Closure) {
<a name="line1807"></a>            call_user_func_array($data, [ & $this]);
<a name="line1808"></a>            $data = null;
<a name="line1809"></a>        }
<a name="line1810"></a>        // 分析查询表达式
<a name="line1811"></a>        $options = $this->parseExpress();
<a name="line1812"></a>
<a name="line1813"></a>        if (!is_null($data)) {
<a name="line1814"></a>            // AR模式分析主键条件
<a name="line1815"></a>            $this->parsePkWhere($data, $options);
<a name="line1816"></a>        }
<a name="line1817"></a>
<a name="line1818"></a>        $options['limit'] = 1;
<a name="line1819"></a>        $result           = false;
<a name="line1820"></a>        if (empty($options['fetch_sql']) && !empty($options['cache'])) {
<a name="line1821"></a>            // 判断查询缓存
<a name="line1822"></a>            $cache = $options['cache'];
<a name="line1823"></a>            if (true === $cache['key'] && !is_null($data) && !is_array($data)) {
<a name="line1824"></a>                $key = 'think:' . $options['table'] . '|' . $data;
<a name="line1825"></a>            } else {
<a name="line1826"></a>                $key = is_string($cache['key']) ? $cache['key'] : md5(serialize($options));
<a name="line1827"></a>            }
<a name="line1828"></a>            $result = Cache::get($key);
<a name="line1829"></a>        }
<a name="line1830"></a>        if (!$result) {
<a name="line1831"></a>            // 生成查询SQL
<a name="line1832"></a>            $sql = $this->builder()->select($options);
<a name="line1833"></a>            if ($options['fetch_sql']) {
<a name="line1834"></a>                // 获取实际执行的SQL语句
<a name="line1835"></a>                return $this->connection->getRealSql($sql, $this->bind);
<a name="line1836"></a>            }
<a name="line1837"></a>            // 执行查询
<a name="line1838"></a>            $result = $this->query($sql, $this->getBind(), $options['master'], $options['fetch_class']);
<a name="line1839"></a>
<a name="line1840"></a>            if ($result instanceof \PDOStatement) {
<a name="line1841"></a>                // 返回PDOStatement对象
<a name="line1842"></a>                return $result;
<a name="line1843"></a>            }
<a name="line1844"></a>
<a name="line1845"></a>            if (isset($cache)) {
<a name="line1846"></a>                // 缓存数据
<a name="line1847"></a>                Cache::set($key, $result, $cache['expire']);
<a name="line1848"></a>            }
<a name="line1849"></a>        }
<a name="line1850"></a>
<a name="line1851"></a>        // 数据处理
<a name="line1852"></a>        if (!empty($result[0])) {
<a name="line1853"></a>            $data = $result[0];
<a name="line1854"></a>            if (!empty($this->model)) {
<a name="line1855"></a>                // 返回模型对象
<a name="line1856"></a>                $model = $this->model;
<a name="line1857"></a>                $data  = new $model($data);
<a name="line1858"></a>                $data->isUpdate(true, isset($options['where']['AND']) ? $options['where']['AND'] : null);
<a name="line1859"></a>                // 关联查询
<a name="line1860"></a>                if (!empty($options['relation'])) {
<a name="line1861"></a>                    $data->relationQuery($options['relation']);
<a name="line1862"></a>                }
<a name="line1863"></a>                if (!empty($options['with'])) {
<a name="line1864"></a>                    // 预载入
<a name="line1865"></a>                    $data->eagerlyResult($data, $options['with'], is_object($result) ? get_class($result) : '');
<a name="line1866"></a>                }
<a name="line1867"></a>            }
<a name="line1868"></a>        } elseif (!empty($options['fail'])) {
<a name="line1869"></a>            if (!empty($this->model)) {
<a name="line1870"></a>                throw new ModelNotFoundException('model data Not Found:' . $this->model, $this->model, $options);
<a name="line1871"></a>            } else {
<a name="line1872"></a>                throw new DataNotFoundException('table data not Found:' . $options['table'], $options['table'], $options);
<a name="line1873"></a>            }
<a name="line1874"></a>        } else {
<a name="line1875"></a>            $data = null;
<a name="line1876"></a>        }
<a name="line1877"></a>        return $data;
<a name="line1878"></a>    }
<a name="line1879"></a>
<a name="line1880"></a>    /**
<a name="line1881"></a>     * 查找多条记录 如果不存在则抛出异常
<a name="line1882"></a>     * @access public
<a name="line1883"></a>     * @param array|string|Query|\Closure $data
<a name="line1884"></a>     * @return array|\PDOStatement|string|Model
<a name="line1885"></a>     * @throws DbException
<a name="line1886"></a>     * @throws Exception
<a name="line1887"></a>     * @throws PDOException
<a name="line1888"></a>     */
<a name="line1889"></a>    public function selectOrFail($data = null)
<a name="line1890"></a>    {
<a name="line1891"></a>        return $this->failException(true)->select($data);
<a name="line1892"></a>    }
<a name="line1893"></a>
<a name="line1894"></a>    /**
<a name="line1895"></a>     * 查找单条记录 如果不存在则抛出异常
<a name="line1896"></a>     * @access public
<a name="line1897"></a>     * @param array|string|Query|\Closure $data
<a name="line1898"></a>     * @return array|\PDOStatement|string|Model
<a name="line1899"></a>     * @throws DbException
<a name="line1900"></a>     * @throws Exception
<a name="line1901"></a>     * @throws PDOException
<a name="line1902"></a>     */
<a name="line1903"></a>    public function findOrFail($data = null)
<a name="line1904"></a>    {
<a name="line1905"></a>        return $this->failException(true)->find($data);
<a name="line1906"></a>    }
<a name="line1907"></a>
<a name="line1908"></a>    /**
<a name="line1909"></a>     * 分批数据返回处理
<a name="line1910"></a>     * @access public
<a name="line1911"></a>     * @param integer   $count 每次处理的数据数量
<a name="line1912"></a>     * @param callable  $callback 处理回调方法
<a name="line1913"></a>     * @param string    $column 分批处理的字段名
<a name="line1914"></a>     * @return boolean
<a name="line1915"></a>     */
<a name="line1916"></a>    public function chunk($count, $callback, $column = null)
<a name="line1917"></a>    {
<a name="line1918"></a>        $column    = $column ?: $this->getPk();
<a name="line1919"></a>        $options   = $this->getOptions();
<a name="line1920"></a>        $bind      = $this->bind;
<a name="line1921"></a>        $resultSet = $this->limit($count)->order($column, 'asc')->select();
<a name="line1922"></a>
<a name="line1923"></a>        while (!empty($resultSet)) {
<a name="line1924"></a>            if (false === call_user_func($callback, $resultSet)) {
<a name="line1925"></a>                return false;
<a name="line1926"></a>            }
<a name="line1927"></a>            $end       = end($resultSet);
<a name="line1928"></a>            $lastId    = is_array($end) ? $end[$column] : $end->$column;
<a name="line1929"></a>            $resultSet = $this->options($options)
<a name="line1930"></a>                ->limit($count)
<a name="line1931"></a>                ->bind($bind)
<a name="line1932"></a>                ->where($column, '>', $lastId)
<a name="line1933"></a>                ->order($column, 'asc')
<a name="line1934"></a>                ->select();
<a name="line1935"></a>        }
<a name="line1936"></a>        return true;
<a name="line1937"></a>    }
<a name="line1938"></a>
<a name="line1939"></a>    /**
<a name="line1940"></a>     * 获取绑定的参数 并清空
<a name="line1941"></a>     * @access public
<a name="line1942"></a>     * @return array
<a name="line1943"></a>     */
<a name="line1944"></a>    public function getBind()
<a name="line1945"></a>    {
<a name="line1946"></a>        $bind       = $this->bind;
<a name="line1947"></a>        $this->bind = [];
<a name="line1948"></a>        return $bind;
<a name="line1949"></a>    }
<a name="line1950"></a>
<a name="line1951"></a>    /**
<a name="line1952"></a>     * 创建子查询SQL
<a name="line1953"></a>     * @access public
<a name="line1954"></a>     * @param bool $sub
<a name="line1955"></a>     * @return string
<a name="line1956"></a>     * @throws DbException
<a name="line1957"></a>     */
<a name="line1958"></a>    public function buildSql($sub = true)
<a name="line1959"></a>    {
<a name="line1960"></a>        return $sub ? '( ' . $this->select(false) . ' )' : $this->select(false);
<a name="line1961"></a>    }
<a name="line1962"></a>
<a name="line1963"></a>    /**
<a name="line1964"></a>     * 删除记录
<a name="line1965"></a>     * @access public
<a name="line1966"></a>     * @param mixed $data 表达式 true 表示强制删除
<a name="line1967"></a>     * @return int
<a name="line1968"></a>     * @throws Exception
<a name="line1969"></a>     * @throws PDOException
<a name="line1970"></a>     */
<a name="line1971"></a>    public function delete($data = null)
<a name="line1972"></a>    {
<a name="line1973"></a>        // 分析查询表达式
<a name="line1974"></a>        $options = $this->parseExpress();
<a name="line1975"></a>
<a name="line1976"></a>        if (!is_null($data) && true !== $data) {
<a name="line1977"></a>            if (!is_array($data)) {
<a name="line1978"></a>                // 缓存标识
<a name="line1979"></a>                $key = 'think:' . $options['table'] . '|' . $data;
<a name="line1980"></a>            }
<a name="line1981"></a>            // AR模式分析主键条件
<a name="line1982"></a>            $this->parsePkWhere($data, $options);
<a name="line1983"></a>        }
<a name="line1984"></a>
<a name="line1985"></a>        if (true !== $data && empty($options['where'])) {
<a name="line1986"></a>            // 如果条件为空 不进行删除操作 除非设置 1=1
<a name="line1987"></a>            throw new Exception('delete without condition');
<a name="line1988"></a>        }
<a name="line1989"></a>        // 生成删除SQL语句
<a name="line1990"></a>        $sql = $this->builder()->delete($options);
<a name="line1991"></a>
<a name="line1992"></a>        if ($options['fetch_sql']) {
<a name="line1993"></a>            // 获取实际执行的SQL语句
<a name="line1994"></a>            return $this->connection->getRealSql($sql, $this->bind);
<a name="line1995"></a>        }
<a name="line1996"></a>
<a name="line1997"></a>        // 检测缓存
<a name="line1998"></a>        if (isset($key) && Cache::get($key)) {
<a name="line1999"></a>            // 删除缓存
<a name="line2000"></a>            Cache::rm($key);
<a name="line2001"></a>        }
<a name="line2002"></a>        // 执行操作
<a name="line2003"></a>        return $this->execute($sql, $this->getBind());
<a name="line2004"></a>    }
<a name="line2005"></a>
<a name="line2006"></a>    /**
<a name="line2007"></a>     * 分析表达式（可用于查询或者写入操作）
<a name="line2008"></a>     * @access protected
<a name="line2009"></a>     * @return array
<a name="line2010"></a>     */
<a name="line2011"></a>    protected function parseExpress()
<a name="line2012"></a>    {
<a name="line2013"></a>        $options = $this->options;
<a name="line2014"></a>
<a name="line2015"></a>        // 获取数据表
<a name="line2016"></a>        if (empty($options['table'])) {
<a name="line2017"></a>            $options['table'] = $this->getTable();
<a name="line2018"></a>        }
<a name="line2019"></a>
<a name="line2020"></a>        if (!isset($options['where'])) {
<a name="line2021"></a>            $options['where'] = [];
<a name="line2022"></a>        } elseif (isset($options['view'])) {
<a name="line2023"></a>            // 视图查询条件处理
<a name="line2024"></a>            foreach (['AND', 'OR'] as $logic) {
<a name="line2025"></a>                if (isset($options['where'][$logic])) {
<a name="line2026"></a>                    foreach ($options['where'][$logic] as $key => $val) {
<a name="line2027"></a>                        if (array_key_exists($key, $options['map'])) {
<a name="line2028"></a>                            $options['where'][$logic][$options['map'][$key]] = $val;
<a name="line2029"></a>                            unset($options['where'][$logic][$key]);
<a name="line2030"></a>                        }
<a name="line2031"></a>                    }
<a name="line2032"></a>                }
<a name="line2033"></a>            }
<a name="line2034"></a>
<a name="line2035"></a>            if (isset($options['order'])) {
<a name="line2036"></a>                // 视图查询排序处理
<a name="line2037"></a>                if (is_string($options['order'])) {
<a name="line2038"></a>                    $options['order'] = explode(',', $options['order']);
<a name="line2039"></a>                }
<a name="line2040"></a>                foreach ($options['order'] as $key => $val) {
<a name="line2041"></a>                    if (is_numeric($key)) {
<a name="line2042"></a>                        if (strpos($val, ' ')) {
<a name="line2043"></a>                            list($field, $sort) = explode(' ', $val);
<a name="line2044"></a>                            if (array_key_exists($field, $options['map'])) {
<a name="line2045"></a>                                $options['order'][$options['map'][$field]] = $sort;
<a name="line2046"></a>                                unset($options['order'][$key]);
<a name="line2047"></a>                            }
<a name="line2048"></a>                        } elseif (array_key_exists($val, $options['map'])) {
<a name="line2049"></a>                            $options['order'][$options['map'][$val]] = 'asc';
<a name="line2050"></a>                            unset($options['order'][$key]);
<a name="line2051"></a>                        }
<a name="line2052"></a>                    } elseif (array_key_exists($key, $options['map'])) {
<a name="line2053"></a>                        $options['order'][$options['map'][$key]] = $val;
<a name="line2054"></a>                        unset($options['order'][$key]);
<a name="line2055"></a>                    }
<a name="line2056"></a>                }
<a name="line2057"></a>            }
<a name="line2058"></a>        }
<a name="line2059"></a>
<a name="line2060"></a>        // 表别名
<a name="line2061"></a>        if (!empty($options['alias'])) {
<a name="line2062"></a>            $options['table'] .= ' ' . $options['alias'];
<a name="line2063"></a>        }
<a name="line2064"></a>
<a name="line2065"></a>        if (!isset($options['field'])) {
<a name="line2066"></a>            $options['field'] = '*';
<a name="line2067"></a>        }
<a name="line2068"></a>
<a name="line2069"></a>        if (!isset($options['strict'])) {
<a name="line2070"></a>            $options['strict'] = $this->getConfig('fields_strict');
<a name="line2071"></a>        }
<a name="line2072"></a>
<a name="line2073"></a>        foreach (['master', 'lock', 'fetch_class', 'fetch_sql', 'distinct'] as $name) {
<a name="line2074"></a>            if (!isset($options[$name])) {
<a name="line2075"></a>                $options[$name] = false;
<a name="line2076"></a>            }
<a name="line2077"></a>        }
<a name="line2078"></a>
<a name="line2079"></a>        foreach (['join', 'union', 'group', 'having', 'limit', 'order', 'force', 'comment'] as $name) {
<a name="line2080"></a>            if (!isset($options[$name])) {
<a name="line2081"></a>                $options[$name] = '';
<a name="line2082"></a>            }
<a name="line2083"></a>        }
<a name="line2084"></a>
<a name="line2085"></a>        if (isset($options['page'])) {
<a name="line2086"></a>            // 根据页数计算limit
<a name="line2087"></a>            list($page, $listRows) = $options['page'];
<a name="line2088"></a>            $page                  = $page > 0 ? $page : 1;
<a name="line2089"></a>            $listRows              = $listRows > 0 ? $listRows : (is_numeric($options['limit']) ? $options['limit'] : 20);
<a name="line2090"></a>            $offset                = $listRows * ($page - 1);
<a name="line2091"></a>            $options['limit']      = $offset . ',' . $listRows;
<a name="line2092"></a>        }
<a name="line2093"></a>
<a name="line2094"></a>        $this->options = [];
<a name="line2095"></a>        return $options;
<a name="line2096"></a>    }
<a name="line2097"></a>
<a name="line2098"></a>}
<a name="line2099"></a></pre>
<div class="header">
<h1>ThinkPHP</h1>
<ul>
<li><a href="../overview-summary.html">Overview</a></li>
<li>Package</li><li>Class</li><li>Tree</li><li><a href="../overview-files.html">Files</a></li>
<li><a href="../deprecated-list.html">Deprecated</a></li>
<li><a href="../todo-list.html">Todo</a></li>
<li><a href="../index-all.html">Index</a></li>
</ul>
</div>

<div class="small_links">
<a href="../index.html" target="_top">Frames</a>
<a href="../source\library\think\db\query.php.html" target="_top">No frames</a>
</div>
<hr>

<p id="footer">This document was generated by <a href="http://peej.github.com/phpdoctor/">PHPDoctor: The PHP Documentation Creator</a></p>

</body>

</html>